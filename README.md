# gov-llm-e2e-testkit

自治体向け LLM サービスを対象とした  
**E2E（End-to-End）自動テスト／実行観測基盤**です。

Python + Playwright を用いて、

- 条例・規程ナレッジを前提とした QA 実行
- UI 経由での LLM 応答取得
- 応答生成過程の観測・記録
- 回答素材（answer.md）の再現可能な収集

を **評価を行わずに** 実現することを目的としています。

本リポジトリは **プロダクション向け SDK ではなく**、  
自治体業務・閉域環境（LGWAN 相当）での実運用検証を想定した  
**非公式・実験的テストキット**です。

---

## このプロジェクトがやること / やらないこと

### やること（This project **is**）

- **E2E 実行基盤**（Python + Playwright）
  - ログイン → チャット送信 → 回答待ち → 回答素材の回収
- **観測のための成果物出力（ログ生成）**
  - 実行条件・観測事実・DOM 由来の回答素材を  
    ファイルとして残すデータを引き渡す役割

### やらないこと（This project **is NOT**）

このプロジェクトは、意図的に以下を対象外にします。

- 回答品質・正誤・有用性を評価すること
- UI DOM の契約化や安定化を保証すること
- 回答の修復・再試行・最適化を行うこと

> **評価は別プロジェクトで行います**  
> 本リポジトリでは「壊れない観測」と「再現可能な記録」だけを扱います。

---

## 想定読者と読むべき文書

本リポジトリは、利用目的に応じて参照すべき文書が異なります。  
**README は入口（ナビゲーション）であり、実行手順の正本ではありません。**

### 一般利用者（職員・評価者）

- 条例 HTML と質問セットを用意し、
  ツールを実行して結果を確認したい方

→ **実行手引書はこちらを参照してください**

- `docs/README_Question_Resolution.md`

※ ルート README には、具体的な実行手順や操作方法は記載していません。

---

### 管理者・開発者・設計レビュワー

- プロジェクト全体の目的・責務範囲を把握したい方
- フェーズ構成、設計判断、進行状態を確認したい方

→ 以下の文書を正本として参照してください。

- `PROJECT_STATUS.md`（現在地・フェーズ状態）
- `CHANGELOG.md`（設計・仕様変更の履歴）
- `docs/PROJECT_GRAND_RULES.md`（不変ルール・設計原則）
- `docs/Roadmap.md`（フェーズ定義と全体構成）

---

## リポジトリ構成

```text
.
├─ README.md                # このファイル（プロジェクトの入口）
├─ CHANGELOG.md             # 変更履歴（差分の正本）
├─ PROJECT_STATUS.md        # 現在地・フェーズ状態の正本
│
├─ docs/
│  ├─ PROJECT_GRAND_RULES.md    # 不変ルール・設計原則
│  ├─ Debugging_Principles.md   # デバッグ原則（非推測）
│  ├─ Roadmap.md                # フェーズ定義と現在地
│  │
│  ├─ design/                   # 設計文書（最新版のみ）
│  ├─ operation/                # 実行手順・運用ガイド
│  ├─ protocol/                 # Web / VS Code 往復プロトコル
│  ├─ runbook/                  # 運用時の判断手順
│  ├─ guidelines/               # 質問設計・入力ルール
│  ├─ spec/                     # I/F・Golden 資産
│  ├─ test_plan/                # テスト計画
│  └─ archive/                  # 旧版設計・観測ログ（参照のみ）
│
├─ src/                         # 実装（Python）
├─ scripts/                     # 実行用スクリプト
├─ tests/                       # pytest
└─ data/                        # テストデータ
```

### `archive/` について

`docs/archive/` 配下には、

- 旧バージョンの設計文書
- 思考過程・検討メモ
- 観測ログ・試行結果
- 完了済みフェーズ（F4 / F7-C 等）

を格納しています。

**参照価値はありますが、正本ではありません。**
設計判断・実装判断は必ず最新版の文書を参照してください。

---

## クイックナビ（どこを見ればいいか）

### 条例ベースで質問を具体化したい人

- 条例 HTML に基づいて、
  抽象的な質問を「条例 ID・条・項が確定した実行用質問」に変換する

→ `docs/README_Question_Resolution.md`

---

### 設計（責務・境界を理解したい人）

- F8 runner / orchestrator（最新・正式）
  - `docs/design/Design_F8_v0.3.1_runner.md`
- 単一質問実行 I/F（実行エンジンの最小単位）
  - `docs/design/Design_F8_AutoQuestion_Execution_v0.1.md`

---

### 実行手順（実際に回す人・最重要）

- **F8-Set-1 実務手順（正本）**
  - `docs/operation/F8-Set-1_Procedure_v1.0.md`

> ⚠️ 注意  
> README は概要説明のみです。  
> **実行手順・禁止事項・成果物の正しい扱いは、必ず上記実務手順を正本として参照してください。**

---

## フェーズ構成（概要）

本プロジェクトは Roadmap に基づき、
以下のフェーズで段階的に進行しています。

- F1–F3：E2E テスト基盤構築
- F4：RAG 入力差分影響の観測データ生成
- F5：CI（Smoke Test）整備
- F7：制御付き実運用試行
- **F8：Markdown 価値判断フェーズ（回答素材収集）**
- F9：価値評価・比較指標定義（未着手）

現在の到達点は **PROJECT_STATUS.md** を参照してください。

---

## F8：回答素材収集フェーズ

F8 フェーズでは、各質問に対して **必ず `answer.md` を生成**します。

```text
## Question
## Answer (Extracted)   # 評価対象（DOM 抽出結果）
## Answer (Raw)         # 観測用（UI DOM 全体）
## Metadata (Observed)
```

- 抽出は UI DOM に対する **best-effort**
- 成否ではなく **状態（status）として記録**
- 書式保持・意味理解・評価は行いません

---

## 実行方法（最小）

- 手動検証（F8 runtime 検証）
  - `scripts/run_f8_set1_manual.py` を使用

実行に必要な設定（認証情報、対象環境、禁止事項）は
**必ず** `docs/operation/F8-Set-1_Procedure_v1.0.md` を参照してください。

---

## 実行前提：`.env` 切替について（F9-B）

本プロジェクトでは、実行時に読み込まれる `.env` ファイルを  
**実行前に人間が明示的に切り替える**運用を採用しています。

これは、F9-B（実行条件固定・ナレッジ切替）で確定した  
**「実行条件を事前に固定し、後から特定可能にする」**という設計原則に基づくものです。

### 基本的な考え方

- Python / pytest は **常に `.env` というファイルを読む**
- どの実行条件で動かすかは、  
  実行前に `.env` ファイルを切り替えることで確定させる
- 実行結果から「どの条件で実行されたか」が  
  **ファイルとして特定可能な状態**を作ることを重視する

`.env` の切替は、補助スクリプト（例：`switch_env`）によって  
**ファイル操作のみ**で行われます。

### 役割分担（重要）

```text
人間
└─ switch_env internet_markdown
└─ .env.internet_markdown → .env にコピー

Python / pytest
└─ いつも通り .env を読む（切替の存在は意識しない）
```

- `.env` 切替スクリプトは  
  `.env` の中身を解釈・編集・実行することはありません
- pytest や実行スクリプトの起動は  
  **必ず人間が明示的に行います**

### `.env` ファイルの命名規則

本プロジェクトでは、以下の形式を正式採用しています。

```text
.env.<network>_<variant>
```

例：

```texr
.env.internet_html
.env.internet_markdown
.env.lgwan_html
```

- 拡張子は使用しません（Windows 環境での誤動作防止）
- ファイル名は **識別子**であり、  
  その意味（HTML / Markdown ナレッジ等）は  
  README や実行記録で補完します

### `.env` が既に存在する場合の扱い

`.env` 切替スクリプトは、安全性を優先し、  
**既存の `.env` がある状態では自動で上書きしません**。

- `.env` が存在する場合：
  - 原則として **エラー終了**します
  - 上書きする場合は、  
    人間が明示的に「上書きする」意思を示す必要があります
- これにより：
  - 実行条件の意図しない切替
  - 認証情報の破壊
  - 実行条件不明な結果生成  
  を防止します

※ `.env` の退避・削除・上書き判断は  
　**人間の責務**とします。

### なぜ「実行時に env を指定しない」のか

以下のような方式は、本プロジェクトでは採用しません。

```bash
python run.py --env internet_markdown
```

- 実行ごとに条件が変わり得る
- 実行結果から使用条件を特定しにくい
- CI や自動化と混線しやすい
- F9-B の「実行条件固定」原則に反する

そのため本プロジェクトでは、

- ❌ 実行時に条件を切り替える
- ✅ 実行前に条件を固定する

という運用を採用しています。

### まとめ（1行）

> `.env` 切替スクリプトは  
> 「読み込む `.env` を指定する」のではなく、  
> 「読み込まれる `.env` を事前に確定させる」ための補助ツールです。

詳細な操作手順は、`docs/operation/` 配下の正本文書を参照してください。

---

## 成果物の取り扱い（重要）

- 成果物は「評価結果」ではなく **観測ログ（一次情報）**です
- 上書き・差し替えは行いません（再現性確保のため）
- 回答の良否・正確性は、このリポジトリでは判断しません

---

## Contributing

Issue / PR は歓迎しますが、本リポジトリは  
**フェーズと責務境界が厳密**なプロジェクトです。

- 変更前に該当フェーズの設計（`docs/design/Design_*.md`）を確認してください
- ロジック変更を伴う場合は、設計方針の提示を必須とします

---

## ライセンス（License）

- 本プロジェクトは非公式のテストキットです
- 特定ベンダー／特定サービスの動作保証は行いません
- 本ツールの利用により生じたいかなる損害についても責任を負いません

This project is licensed under the MIT License.

---
