---
title: Design_rag_f4_operation_rules_v0.1.1
project: gov-llm-e2e-testkit
phase: F4 (RAG Evaluation)
status: Approved (Operational Rule)
supersedes: Design_rag_f4_operation_rules_v0.1
date: 2025-12-14
---

# F4 RAG 評価フェーズ 運用ルール v0.1.1

## 0. Purpose（本書の目的）

本書は、F4 フェーズにおいて実施する
**HTML vs Markdown 差分評価を「評価可能・再現可能な状態」で運用するための前提条件**
を明文化・固定することを目的とする。

本ルールはコード設計書ではなく、
**評価の信頼性・再現性を担保するための運用境界定義**である。

F4 v0.1.x が終了するまで、本書の内容は原則として変更しない。

---

## 1. Authority（位置づけ）

- 本ルールは、F4 フェーズにおける評価運用の最上位前提とする。
- 以下の設計書・実装は、本ルールに従うものとする。
  - Design_rag_f4_eval_v0.1
  - Design_pytest_f4_results_writer_v0.1
  - F4_results_template_v0.1
- 本ルールに反する条件で取得された評価結果は
  **F4 評価結果として採用しない**。

---

## 2. F4 v0.1.x の評価スコープ（再確認）

F4 v0.1.x の目的は、以下に限定される。

> **同一質問・同一評価条件のもとで、
> ナレッジ形式（HTML / Markdown）の違いが
> RAG 応答に与える影響を差分として観測すること**

### 明示的にスコープ外とする事項

- 絶対評価（良い／悪いの断定）
- モデル間比較
- 意味的同義語判定
- ノイズ耐性評価
- 自動要約品質評価

これらは **F4 v0.2 以降**で検討対象とする。

---

## 3. アカウント・プロファイル運用ルール（最重要）

### 3.1 アカウント分離を必須とする

F4 v0.1.x では、以下の **2アカウント分離**を必須とする。

| 用途 | 内容 |
|---|---|
| HTML 用 | HTML 形式ナレッジのみを投入したテストアカウント |
| Markdown 用 | Markdown 形式ナレッジのみを投入したテストアカウント |

#### 理由

- ナレッジ削除後のインデックス残留を完全に否定できない
- embedding / cache 混在の可能性を排除するため
- 差分評価における主変数（ナレッジ形式）を汚染しないため

---

### 3.2 profile 切替方式（v0.1.x 固定）

#### 結論：**v0.1.x では手動切替とする**

pytest 実行時の profile 切替は、**自動化しない**。

以下のいずれか **一方に固定**して運用すること。

- `env.yaml` を手動編集して profile を切り替える
- 環境変数（例：`PROFILE=html` / `PROFILE=markdown`）を手動設定する

※ プロジェクト内では **どちらか一方に統一**すること。
※ 両方式の混在は禁止。

#### 理由

- env_loader / CI との結合条件が v0.1.x では未確定
- 自動切替は評価基盤の責務を逸脱するため

---

## 4. ナレッジ投入ルール（Case 単位）

### 4.1 Case ごとに単独ナレッジ投入を厳守

F4 v0.1.x では、**1 Case = 1 条例ファイル投入**を原則とする。

| Case | ナレッジ状態 |
|---|---|
| Case 1 | 条例 A のみ |
| Case 2 | 条例 B のみ |
| Case 3 | 条例 C のみ |

#### 禁止事項

- Case1 の条例を残したまま Case2 を実行すること
- 複数条例を同時に投入した状態で Case を実行すること

#### 理由

- 質問文の指示対象が曖昧になる
- 評価対象が「ナレッジ形式差分」から「検索曖昧性」にすり替わる

---

### 4.2 ナレッジ削除・入替の扱い（v0.1.x）

- ナレッジのアップロード／削除は **人手運用を許容**する
- pytest スクリプトでは制御しない
- 実行者は、Case 実行前に
  **単独ナレッジ状態であることを確認する責務**を負う

---

## 5. 質問文の固定・一意化ルール

### 5.1 HTML / Markdown 間で質問文は完全一致とする

- 表記
- 改行
- 記号

を含め、**1 文字たりとも変更してはならない**。

---

### 5.2 Case2 / Case3 に向けた一意化ルール（重要）

複数 Case を想定する場合、質問文には **必ず条例を一意に識別できる情報**を含める。

#### 必須要件（いずれか）

- 条例 ID（例：`k518RG00000064`）
- 正式条例名（省略不可）

#### 例（OK）

- 「**k518RG00000064（○○条例）**の目的を説明してください。」

#### 例（NG）

- 「この条例の目的を説明してください。」

---

## 6. 結果ログ出力ルール（v0.1.1 追加）

### 6.1 上書き防止を必須とする

F4 評価結果ログは、**上書きされない命名規約**を必須とする。

#### 必須構成要素

- `case_id`
- `profile`（html / markdown）
- `timestamp`

#### 命名例

```text
F4_results_{case_id}*{profile}*{YYYYMMDD_HHMMSS}.md
```

#### 理由

- HTML / Markdown の結果を安全に並存させるため
- Run 間差分・Stability 観測を可能にするため

---

## 7. 自動化範囲の明確化（再掲）

### 7.1 pytest が担う責務

- 質問送信（ChatPage.submit）
- Answer Detection（probe）
- Evidence 抽出
- F4 結果ログ（Markdown）生成

---

### 7.2 v0.1.x で自動化しない範囲

- プライベートナレッジ管理画面の操作
- ナレッジのアップロード／削除
- 管理 UI の DOM 操作

※ これらは v0.2 以降で再検討する。

---

## 8. 実行順序（固定）

1. HTML 用アカウントで Case 実行
2. F4 結果ログ生成（HTML / profile=html）
3. Markdown 用アカウントで **同一 Case / 同一質問文** 実行
4. F4 結果ログ生成（Markdown / profile=markdown）
5. 差分は **人手で観測記録**（v0.1.x）

---

## 9. Conclusion（固定宣言）

本運用ルール v0.1.1 により、

- HTML vs Markdown 差分評価における
- 評価条件
- 主変数（ナレッジ形式）
- 非主変数（アカウント／質問／投入状態）

が明確に分離された。

F4 v0.1.x の評価結果は、
**本ルールを満たした場合のみ有効**とする。

---

以上。
