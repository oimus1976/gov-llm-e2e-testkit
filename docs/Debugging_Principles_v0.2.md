# 🧭 **Debugging Principles v0.2（完全改訂版）**

gov-llm-e2e-testkit / reiki-rag-converter / Gemini-DeepResearch 系共通デバッグ基準
最終更新：2025-12-10

---

## 🏁 **目的**

本書は、AI × 自治体OSSプロジェクトにおける
**「再現性の高い・事故を起こさない・対症療法に流れない」**
デバッグ方法を体系化した指針である。

Playwright / pytest / RAG / DOMパーサ / CI など異なる領域に共通して
**調査 → 仮説 → 検証 → 結論**
の質を最大化するためのルールを定義する。

---

## 🔥 **原則 1：推測する前に必ず “一次情報” を見る**

### デバッグにおける最大の禁忌は **「多分こうだろう」** と当てずっぽうで直すこと。

次の素材を確認するまでは、修正案を出してはならない：

* ✦ **実際のエラーログ全文（pytest, CI, ローカル）**
* ✦ **実行されているコードの実体**
* ✦ **実DOM / URL / HTML / network 状態**
* ✦ **env.yaml / .env / CI の環境変数設定**
* ✦ **ファイルパス・パーミッション・importの実解決パス**

> 「見ずに考える」ではなく
> **「見たうえで考える」** にプロセスを反転すること。

---

## 🔥 **原則 2：仮説は 1〜2 個に絞り理由を明確にする**

デバッグでは多数の可能性を同時に追うのではなく、
必ず **優先度の高い仮説から順に検証**する。

### 仮説は必ずこう書く：

```
仮説A：selector が不一致 → DOM 構造と locator の不整合。
理由：CI ログでは element not attached、ローカルでは visible、などの差があるため。
```

ポイント：

* 仮説は「多くて 2 個まで」
* 原因候補を列挙するだけは禁止
* 「理由を添えた仮説」にすることで必ず検証可能になる

---

## 🔥 **原則 3：仮説には必ず “検証手段” をセットで提示する**

仮説だけ言うのは不十分。
必ず **「こう検証すれば真偽が判定できる」** を添える。

例：

* `python validation_login.py` を作ってログインだけ試す
* `page.title()` をプリントして遷移済みか確認
* `--headed` と `--headless` の動作差分を比較
* `pytest -k nothing` で import だけ確認する
* DOM を `page.content()` で保存し、例外発生箇所と照合する

> 仮説 ⇒ 検証 ⇒ ログ取得 ⇒ 次の仮説
> この「一筆書き」プロセスが Debugging v0.2 の核。

---

## 🔥 **原則 4：修正案を出す前に “影響範囲” を洗い出す**

特に gov-llm-e2e-testkit / RAG / converter 系では
1箇所の変更が別レイヤに波及する。

修正案を出す前に必ず確認：

* PageObject の責務と一致しているか
* BasePage の設計と衝突しないか
* pytest フィクスチャと整合しているか
* CI の headless 実行時に壊れないか
* env_loader / log_writer / DOM 取得まわりに副作用がないか

→ **影響範囲を見ずに「とりあえず直す」は禁止。**

---

## 🔥 **原則 5：暫定対処（ハック）は “必ず時限性を明示” する**

一時的な対症療法が必要な場面はあるが、
以下のルールに従う：

* 暫定実装には必ず `TODO: remove after ___` を付ける
* 設計書に「暫定的理由」を残す
* 重要部分にハックを残したまま merge してはいけない

### 特に禁止：

* 「とりあえず動くからOK」
* 「CIだけ通ればいい」
* 「あとで直すと言いながら無期限放置」

これは未来の自分を殺す。

---

## 🔥 **原則 6：責務境界（Responsibility Map）に違反する修正は禁止**

PageObject / env_loader / RAG validator など、
各レイヤは **責務が定義されている**。

例：

* LoginPage はログインのみ
* ChatSelectPage はカード選択のみ
* ChatPage は送信・受信処理のみ
* BasePage はユーティリティのみ

### これらに跨る修正は “根本から設計を壊す” ため、慎重に扱う。

責務から外れた修正案は、原則として採用しない。

---

## 🔥 **原則 7：変更前後で必ず「再現性テスト」を行う**

修正後、次を必ず確認：

* ローカルで同じコマンドを再実行
* `pytest -vv -s` でログを見ながら動かす
* CI で headless 実行して差異が出ないか確認
* DOM diff（両方の HTML を比較）

**再現性の保証なしに merge してはいけない。**

---

## 🔥 **原則 8：CI（headless）を “真の本番環境” とみなす**

CI 上の失敗は、ほぼすべて
**SPA・遷移タイミング問題・locator 不一致**。

ローカルで通っても CI が落ちたら
CI を正とし、再現スクリプトを作って改めて分析する。

> 「ローカルOKでも CI ダメ」は
> **100% ローカル側の見落とし** と考える。

---

## 🔥 **原則 9：変更理由と観測事実を必ずセットで記録する**

修正ログ（CHANGELOG）・設計書更新時：

* 観測したエラー
* 原因と仮説
* どう検証したか
* なぜこの修正にしたか

を簡潔に残す。

**事実ベース記録のない修正は信用しない。**

---

## 🔥 **原則 10：曖昧な状態のまま推し進めない**

次に該当する場合は必ず停止して状況整理：

* DOM が不安定
* 遷移条件が曖昧
* config が齟齬を起こしている
* PageObject の依存方向がうまく説明できない

> 「よく分からないけど動く」は最悪の状態。

必ず **「説明できる状態」** まで戻る。

---

## 🧩 **付録：デバッグ時の基本フロー（チェックリスト）**

```
□ エラーログを全文読む
□ 関連コード（呼び出し元〜該当関数）を見る
□ DOM / URL / 状態を確認する
□ 仮説を 1〜2 個に絞る
□ 仮説に対して検証手段を定義する
□ 最小スクリプトで検証する
□ 修正案の影響範囲を確認する
□ 修正 → ローカル再現 → CI 再現を行う
□ CHANGELOG / 設計書に反映する
```

---

## 🏁 まとめ

Debugging Principles v0.2 は
**「推測しない・一次情報を最優先・検証を必ず添える」**
という、AI × OSS プロジェクトに必須の標準デバッグ指針。

この原則は gov-llm-e2e-testkit の全ての実装・修正・議論の前提として
**毎回自動適用される**。

---

