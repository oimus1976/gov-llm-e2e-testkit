# Development Guide — Safe Edit Patterns

*(for gov-llm-e2e-testkit)*

## 目的

このドキュメントは、本プロジェクトにおいて **部分修正による事故（特に Python のインデント崩壊）を防止**し、
ChatGPT を併用した開発でも **安全・高速に修正を進めるための実践ルール**を定める。

対象読者：

* 本リポジトリを日常的に編集する開発者（主に自分）
* 将来の自分（数週間〜数か月後）

---

## 基本原則（最重要）

### 原則 1：**部分修正を避ける**

* 既存ブロックの途中にコードを差し込まない
* if / for / try の中を直接いじらない

👉 **「1行だけ足す」が一番危険**

---

### 原則 2：**追加ロジックは“外に出す”**

* 新しい処理は必ず関数・ブロックとして独立させる
* 既存コード側の変更は「関数呼び出し 1 行」に限定する

---

### 原則 3：**実験は本体コードから隔離する**

* 実験・検証目的の変更は以下で吸収する：

  * 環境変数
  * CI workflow
  * 外部スクリプト
* 安定版コード（probe / page / core logic）は極力触らない

---

## ❌ やってはいけない修正（アンチパターン）

### アンチパターン A：既存ブロックへの直接挿入

```python
if condition:
    do_a()
    # ChatGPT から持ってきたコードをここに貼る ← NG
    do_b()
```

* インデント事故の温床
* 差分レビューが困難
* 元に戻しにくい

---

### アンチパターン B：試験用ロジックの常駐

```python
# 検証のため一時的に追加（そのまま残る）
if debug_flag:
    ...
```

* 本番挙動と検証挙動の区別が曖昧になる
* 「なぜこの分岐があるのか？」が後から分からなくなる

---

## ✅ 推奨パターン（安全）

### パターン 1：関数として外に出す（最優先）

```python
def _experimental_logic(...):
    # 新規ロジック（ChatGPT 由来でもOK）
    ...

# 既存コード側は 1 行だけ
if condition:
    _experimental_logic(...)
```

**メリット**

* インデント事故がほぼ起きない
* 削除・差し替えが容易
* 差分が読みやすい

---

### パターン 2：環境変数ガード（検証用途）

```python
import os

if os.environ.get("EXPERIMENTAL_FEATURE_X") == "1":
    run_experimental_path()
else:
    run_default_path()
```

**用途**

* ローカル検証
* CI の Case 分岐
* Phase 2 / Phase 3 のような一時検証

---

### パターン 3：CI / workflow 側で吸収（表示・実験系）

```yaml
- name: Render CI summary
  run: |
    python scripts/render_ci_summary.py
```

* 表示・整形・ログ解釈は **CI に閉じる**
* Python 本体コードを汚さない

---

### パターン 4：スクリプト分離（複雑化したら即）

```bash
python scripts/experimental_probe_runner.py
```

* YAML にロジックを書かない
* Bash × YAML × Python の三重地獄を避ける

---

## ChatGPT からコードを貼るときのルール

### OK

* 関数単位で貼る
* 新規ファイルとして貼る
* env ガード付きで貼る

### NG

* 既存関数の途中に貼る
* try / except の中に直接貼る
* インデントを目視で合わせようとする

---

## インデント事故を防ぐ運用ルール

* **インデントは自分で打たない**
* VS Code の自動整形に任せる
* 修正後は必ず：

  ```bash
  black <target_file.py>
  ```

---

## 判断に迷ったときのチェックリスト

修正前に、以下を自問する：

* [ ] これは部分修正か？
* [ ] 関数として外に出せないか？
* [ ] env / CI 側で吸収できないか？
* [ ] 後で `git restore` しやすい形か？

**1つでも No があれば、設計を見直す。**

---

## このガイドの位置づけ

* 本書は **実装規約ではない**
* しかし **事故防止のための強い推奨**である
* 本プロジェクトでは「速さ」より「戻しやすさ」を優先する

---

## 更新方針

* 実際に事故りかけた事例が出たら追記する
* ルールを破った結果うまくいかなかった場合も記録する
* 完璧を目指さず、**効いた知見だけ残す**

---

*Last updated: v0.1 (initial draft)*

---
