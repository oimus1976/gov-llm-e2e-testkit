---
doc_type: spec
project: gov-llm-e2e-testkit
phase: F9
backlog: B
title: Execution Conditions Freeze and Knowledge Switching (Formal Implementation)
version: v0.1r
status: fix
date: 2025-12-30
related_phase:
  - F9
  - F4
related_docs:
  - PROJECT_STATUS.md
  - Roadmap.md
non_goals:
  - 回答内容の評価・品質判断
  - ナレッジ内容の正誤検証
  - CI への自動組み込み
  - writer / rag_entry の内部実装変更
---

## 1. Purpose（目的）

本仕様は、F9 フェーズにおいて  
**比較可能な実行結果を安定して生成するための実行条件を固定し、  
ナレッジベース切替を「再投入」ではなく  
「アカウント差分」によって行う正式な実行モデルを実装する**  
ことを目的とする。

本仕様で定義される仕組みは、F4 において技術的実証が完了しているが、  
**F9 において再現可能・引き渡し可能な成果物として正式実装する**。

---

## 2. Scope（対象範囲）

### 2.1 本仕様が定義するもの

- ナレッジ切替の原則（再投入を行わない）
- アカウント切替によるナレッジ可視範囲の切替モデル
- `.env` ファイル切替による実行条件固定方式
- `.env` 切替を行う補助スクリプト（バッチ）の責務
- 比較可能性を維持するための前提条件

### 2.2 本仕様が定義しないもの（Non-Goals）

- ナレッジデータの生成・加工・検証
- CI / GitHub Actions への自動組み込み
- 実行スケジューリング・統計処理
- profile による UI / DOM 挙動の切替仕様

---

## 3. Design Principle（設計原則）

### 3.1 再投入禁止原則

- **1 つのアカウントに対して、  
  ナレッジベースの削除・再アップロードを行ってはならない**
- ナレッジ差分は  
  **アカウント（ログイン主体）を切り替えることによって表現する**

> 本原則は、比較実験において  
> ナレッジ差分以外の副作用  
> （例：インデックス再構築、反映遅延等）  
> を持ち込まないためのものである。

### 3.2 差分要因集約原則

- 比較実験における実行条件の差分要因は、  
  **アカウント差分に集約する**
- HTML / Markdown 等のナレッジ形式差分は、  
  **アカウントに紐づく可視範囲の違いとして扱う**

---

## 4. Execution Model（実行モデル）

### 4.1 アカウント切替モデル

- 各アカウントは以下を一意に持つ：
  - ナレッジベースの可視範囲
  - 権限・所属等の属性
- 実行時に使用するアカウントを切り替えることで、  
  **ナレッジ条件を切り替える**

### 4.2 `.env` 切替モデル

- 実行環境は `.env` ファイルによって定義される
- 例：
  - `.env.internet.html`
  - `.env.internet.markdown`
- `.env` ファイルは、実行時に使用される  
  **アカウントおよび実行環境に関する設定情報**を含む
- `.env` の内容変更によって：
  - UI 構造
  - DOM 構造
    が変化することを **前提としない**

---

## 5. `.env` Switching Script（正式実装対象）

### 5.1 提供物

F9 の成果物として、以下を提供する。

- `.env` 切替を行う補助スクリプト
  - **OS に依存しない、または特定 OS に限定しない**
  - 手動実行を前提とする

### 5.2 スクリプトの責務

- 指定された `.env.*` を  
  **実行対象の `.env` として切り替える**
- 切替対象は **ファイル操作のみに限定**する
- 以下は行ってはならない：
  - ナレッジの削除・再投入
  - UI 操作の自動化
  - 実行のトリガー

---

## 6. Comparable Run Conditions（比較可能条件）

以下をすべて満たす場合にのみ、
実行結果は **比較可能（Comparable Run）**とみなす。

- 使用 UI が同一である
- DOM 抽出仕様が同一である
- 質問文が完全一致している
- 差分要因が **アカウント差分のみ**である
- `.env` 切替以外の実行条件変更が存在しない

---

## 7. Violation Handling（違反時の扱い）

以下に該当する場合、  
当該実行結果は **比較対象外**とする。

- ナレッジを再投入した痕跡がある
- `.env` 切替以外の方法で条件変更が行われている
- **実行条件（使用アカウント・`.env`）が記録・特定できない**

※ 観測データとしての保存は妨げない。

---

## 8. Downstream Boundary（下流責務境界）

- 本仕様で定義される実行条件は：
  - writer
  - rag_entry
  - dataset  
    に **意味的情報を伝えない**
- 下流は本仕様を  
  **前提条件として受け取るのみ**とする

---

## 9. Completion Criteria（完了条件）

以下を満たした時点で、本仕様は **完了**とみなす。

- `.env` 切替スクリプトが実装されている
- 手動操作により、  
  HTML / Markdown ナレッジ差分を  
  **アカウント切替のみで再現できる**
- 上記が README または補助文書に記録されている

---

## 10. Notes

- 本仕様は F4 の実証結果を根拠とするが、  
  **F9 における正式実装を定義するものである**
- CI への自動組み込みは  
  **後続フェーズで検討する**

---
