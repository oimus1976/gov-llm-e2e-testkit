---
title: "Decision Record: テストプラン再構築（工程4→工程5）"
version: v0.1
status: fixed
scope:
  - test_plan_refactor
  - backlog_engineering_4_to_5
related_documents:
  - docs/test_plan/impl_diff_review_v0.2.0.md
  - docs/test_plan/impl_revision_policy_v0.1.md
  - docs/test_plan/test_plan_v0.2.md
applies_to:
  - pytest
  - f4_writer_tests
  - rag_v0_1_tests
excludes:
  - roadmap_phases
  - evaluation_methodology
  - quality_metrics
decision_type: architectural_decision_record
last_updated: 2026-01-11
---

# Decision Record: テストプラン再構築（工程4→工程5）

## 1. 背景と問題意識

本 Decision Record は、  
**テストプラン再構築計画Backlogにおける工程4（差分判断）から工程5（実装修正）に至る判断と実装反映の記録**である。

本プロジェクトにおいて pytest は当初、
「実行が成立したか」「構造が破壊されていないか」を確認するための
**契約保証基盤**として位置づけられていた。

しかし、工程3以前の実装とテスト追加の積み重ねにより、  
pytest は次第に以下の役割を担うようになっていた。

- 回答文中のキーワード一致による意味評価
- PASS / FAIL 判定による品質評価
- 出力内容（Markdown / execution_context）の具体値検証

これらはすべて、
**pytest を「評価主体」として扱う振る舞い**であり、
当初想定していた責務境界からの逸脱であった。

この状態の問題点は、テストが「厳しすぎる」ことではない。  
むしろ、

- 実行環境差分（端末・ネットワーク・UI変動）によって
  pytest の結果が不安定化する
- 評価基準が暗黙に固定され、
  設計判断がテスト実装によって上書きされる
- 本来 pytest の外にあるべき評価・判断が、
  実装の形で不可逆に埋め込まれる

という構造的リスクを内包していた点にある。

工程4では、この状態を前提として、
既存テストを **A / B / C 判定** に分類し、
「直す／残す／直さない」の線引きを設計として確定した。

本 Decision Record は、
その設計判断を **工程5においてどのように実装へ反映し、**
**どの選択肢を採用せず、**
**どの状態を最終形として固定したのか**
を記録するものである。

本書の目的は手順の共有ではない。  
**同じ判断を再度やり直さなくて済む状態を作ること**である。

## 2. 工程4で確定した判断（設計）

工程4の目的は、既存の pytest テスト群を
「良い／悪い」で評価することではなく、  
**責務の観点から再分類し、以後の再判断を不要にすること**であった。

この工程では、全テストを以下の 3 区分に分類した。

### A 判定：維持対象
- pytest の責務（契約・成立・構造保証）に合致している
- 意味評価・品質評価を含まない
- 実行環境差分に対して安定している

A 判定テストは、工程5において **No Action** とすることが確定した。

---

### B 判定：修正対象（縮退）
- pytest 上で意味評価・品質評価を行っている
- 本来 pytest の外にある判断が assert として埋め込まれている
- テストの「厳しさ」ではなく、**責務の逸脱**が問題である

B 判定はさらに、逸脱の性質に応じて以下に整理された。

- **B-α**：キーワード一致・PASS/FAIL 判定などの意味評価
- **B-β**：出力内容（Markdown / JSON 等）の具体値検証
- **B-γ**：試験データ（trial dataset）そのものを前提とした検証

工程4では、これら B 判定テストについて
**削除ではなく「縮退」**を基本方針とした。

縮退とは、
- テスト対象の実行フローは維持する
- ただし、意味評価・品質評価に関する assert をすべて除去する
という判断である。

---

### C 判定：非対象（手を触れない）
- pytest の責務外であることが明確
- 現行スコープでは是正対象としない
- 他工程・別文書に委譲すべきもの

C 判定については、
「直さない」という判断そのものを設計として確定し、
工程5では扱わないことを明示した。

---

### 工程4における最重要判断

工程4で最も重要だったのは、  
**pytest に残す責務と、意図的に持たせない責務を明確に切り分けたこと**である。

具体的には、以下を設計として確定した。

- pytest は「評価」しない
- pytest は「正しさ」を判定しない
- pytest は「意味」を理解しない
- pytest は「実行が成立した事実」のみを保証する

この判断により、
工程5は「どう直すか」を考える工程ではなく、
**「確定した設計を、過不足なく実装へ反映する工程」**
として位置づけられた。

## 3. 工程5で行った実装修正（反映）

工程5の目的は、
工程4で確定した設計判断を「解釈」することではなく、  
**そのまま実装に反映し、判断を固定すること**であった。

したがって、工程5における実装修正は、
機能追加や改善ではなく、
**削除・縮退を中心とした最小限の操作**に限定された。

---

### 3.1 F4 writer 系テストの縮退

F4 writer 系テストでは、以下の振る舞いが確認されていた。

- execution_context を含む Markdown 出力の内容検証
- フィールド名や値の存在・文字列一致を assert する実装

これらは、
F4 の成果物を **評価対象として pytest が検証している**状態であり、
工程4で定義した pytest の責務から逸脱していた。

工程5では、以下の修正を行った。

- `write_f4_result` の呼び出し後に行われていた
  出力内容に関する assert をすべて削除
- F4 実行フロー（質問送信 → 回答取得 → 書き込み）自体は維持

この結果、F4 writer 系テストは、

- 「F4 の処理が例外なく完了すること」
のみを pytest が保証する形に縮退した。

---

### 3.2 RAG basic / advanced v0.1 テストの縮退

RAG v0.1 系テストでは、以下の評価が行われていた。

- 回答文中のキーワード一致判定
- `PASS / FAIL` の算出と assert
- 期待値・非期待値を含む評価ログの生成

これらは、RAG の出力品質を **pytest が直接評価している**状態であり、
評価主体を pytest に置かないという設計判断と矛盾していた。

工程5では、以下の修正を行った。

- キーワード一致判定ロジックの削除
- `PASS / FAIL` 判定および assert の削除
- 評価結果を前提とするフィールドの削除

一方で、

- 質問送信（submit / ask）
- 回答取得（probe 経由）
- 実行ログの生成

といった **実行成立に関わる処理**は維持した。

これにより、RAG v0.1 テストは、

- RAG 実行フローが成立した事実
を pytest が確認する役割に限定された。

---

### 3.3 legacy ask 系テストの除外

legacy ask 系テストは、

- ask API を前提とする
- 現行の Gate / submit フローと整合しない
- pytest 正系として維持する設計根拠が存在しない

という理由から、
工程4の時点で **pytest 正系から外すべき対象**と判断されていた。

工程5では、この判断を実装として明確化するため、

- legacy ask ベースの pytest テストを物理的に削除
- pytest の収集対象から完全に除外

する対応を行った。

この処置により、
pytest の責務境界は実装レベルでも明確化された。

---

### 3.4 「最小 assert を置かない」という決断

工程5では、
縮退後のテストに **最小限の assert を残すか否か**
という選択肢が存在した。

しかし最終的に、

- `is not None` などの形式的な assert も置かない
- 例外が発生しないこと自体を pytest の保証とする

という判断を採用した。

これは、

- 形式的な assert が将来の評価拡張の入口になり得ること
- pytest の責務を「実行成立の事実」に完全に限定すること

を重視した結果である。

この判断により、
工程5で確定した責務境界は、
**実装によって再び曖昧化する余地を残さない形で固定された。**

## 4. 採用しなかった選択肢

工程4から工程5にかけては、
実装修正にあたって複数の選択肢が存在した。
本章では、**検討の結果あえて採用しなかった選択肢**と、
その理由を明示する。

これは反省録ではなく、
**同じ議論を将来繰り返さないための記録**である。

---

### 4.1 最小限の assert を残す案

縮退後のテストに対し、

- `assert result is not None`
- 出力ファイルの存在確認のみを行う assert

といった「形式的な最小 assert」を残す案が検討対象となった。

しかし、この案は最終的に採用しなかった。

理由は以下のとおりである。

- 形式的な assert であっても、
  pytest が「何かを評価する主体」であるという誤解を将来に残す
- 後続の修正で、
  「ここに assert があるなら、もう少し中身も見てよいのではないか」
  という拡張を誘発する可能性が高い
- 実行が成立していれば自明に満たされる条件を
  あえて assert する設計的必然性がない

工程5では、
pytest の責務を **実行が成立したという事実確認のみに限定する**
という判断を優先し、
最小 assert を置かない構成を採用した。

---

### 4.2 legacy ask 系テストを残す案

legacy ask 系テストについては、

- `_legacy` 配下に残したまま pytest 収集対象外とする
- skip マーカーを付与して残す

といった「温存」案も考え得た。

しかし、この案も採用しなかった。

理由は以下のとおりである。

- pytest 配下に存在する限り、
  「正系テストである」という誤解を完全には排除できない
- ask API 前提という設計は、
  現行の Gate / submit フローと整合しない
- 設計上不要であることが明確なテストを
  残す合理的理由が存在しない

工程5では、
**pytest 正系から外すという設計判断を、
実装上も不可逆にすること**
を重視し、物理削除を選択した。

---

### 4.3 pytest に評価を残し続ける案

工程4以前の状態を維持し、

- キーワード一致による判定
- PASS / FAIL による評価

を pytest に残したまま進行する案も、
理論上は存在した。

しかし、この案は工程4の設計判断と
**根本的に矛盾**する。

pytest を評価主体とした場合、

- 実行環境差分により結果が不安定化する
- 評価基準が暗黙に固定され、設計変更が困難になる
- 本来 pytest の外にある判断が実装として埋め込まれる

という問題を回避できない。

そのため工程5では、
pytest を評価主体とする設計自体を
明確に採用しない選択を行った。

---

### 4.4 採用しなかった選択肢の位置づけ

本章で挙げた選択肢は、
「間違っているから却下した」のではない。

いずれも、

- 一時的には便利に見える
- 安心感を与える
- 一般的なテスト観と親和性が高い

という性質を持つ。

しかし本プロジェクトにおいては、
pytest を **契約保証基盤として安定運用する**
という目的に照らした場合、
いずれも長期的なリスクを内包していた。

工程5では、
これらの選択肢を採用しないという判断を含めて、
最終状態を確定させた。

## 5. 最終状態と今後の拘束条件

本 Decision Record により、
テストプラン再構築計画Backlogにおける
**工程4 → 工程5** は完結した。

工程5完了時点で、pytest は以下の状態にある。

- pytest は **評価主体ではない**
- pytest は **意味を判断しない**
- pytest は **品質を判定しない**
- pytest は **実行が成立したという事実のみを保証する**

この状態は、
工程4で確定した設計判断を、
工程5で過不足なく実装に反映した結果であり、
暫定対応ではない。

---

### 5.1 pytest の責務（最終定義）

本プロジェクトにおける pytest の責務は、
以下に限定される。

- テスト対象の実行フローが最後まで到達すること
- 実行中に例外が発生しないこと
- 契約上の入出力構造が破壊されていないこと

これ以外の判断、
すなわち以下は pytest の責務外である。

- 回答内容の正誤判断
- 意味的な妥当性評価
- 品質・性能・有用性の評価
- 評価基準の固定・自動判定

---

### 5.2 今後やってはいけないこと（拘束条件）

本 Decision Record が有効である限り、
以下の行為は行ってはならない。

- pytest に意味評価・品質評価の assert を追加すること
- 出力内容の具体値を検証する assert を追加すること
- pytest を評価主体として扱う実装修正
- 工程4・工程5の設計判断を、実装で上書きすること

これらの行為が必要になった場合は、
本 Decision Record を更新し、
**新たな判断として明示的に記録する必要がある。**

---

### 5.3 本 Decision Record の効力範囲

本書は、以下の範囲に対して効力を持つ。

- テストプラン再構築計画Backlogにおける工程4・工程5
- pytest を用いたテストスイート全体
- F4 writer / RAG v0.1 を含む契約保証テスト

一方で、以下は本書の対象外とする。

- Roadmap におけるフェーズ定義（F1〜F10+）
- 評価・採点・品質指標の設計
- 将来的な評価フェーズ（F10+）での方針

---

### 5.4 完了宣言

以上をもって、

- テストプラン再構築計画Backlogは完結した
- pytest の責務境界は設計・実装の両面で固定された
- 本プロジェクトは通常の開発・検証フェーズへ復帰する

本 Decision Record は、
**工程4 → 工程5 における判断の最終記録**として扱われる。
