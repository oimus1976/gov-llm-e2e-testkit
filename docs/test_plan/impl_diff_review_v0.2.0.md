---
title: Implementation_Diff_Review
version: v0.2.0
project: gov-llm-e2e-testkit
doc_type: design-review
scope: test_plan_v0.2.0 × existing implementation
phase: Phase4
status: drafting
date: 2026-01-11
related_docs:
  - docs/test_plan/test_plan_v0.2.0.md
  - docs/test_plan/appendix_C_relocation_map.md
principles:
  - design-first
  - no-implementation-change
  - decision-with-evidence
---

# Implementation Diff Review v0.2.0

## 1. この文書の目的・位置づけ・完了条件（要約）

### 1.1 目的

本書は、`test_plan_v0.2.0` を唯一の設計正本として、  
既存テスト実装との **差分を裁定し、記録する** ことを目的とする。

ここで行うのは、

- 実装が設計と一致しているか
- 設計と異なる場合、それを **どう扱うか（修正対象か／非修正か）**
を判断することであり、  
**実装修正そのものには着手しない。**

### 1.2 本書の位置づけ

本書はフェーズ4の成果物であり、以下の性格を持つ。

- 実装作業のための **設計レビュー台帳**
- フェーズ5（実装修正）に進むかどうかを判断するための **裁定記録**
- pytest の成否や実行結果を評価・解釈する文書ではない

したがって本書は、

- 実装修正指示書ではない
- 改善提案書ではない
- テスト結果報告書ではない

### 1.3 フェーズ4における判断の範囲

フェーズ4では、以下のみを行う。

- 各 test file が `test_plan_v0.2.0` 上で
  どのレイヤー・どの責務に属するかを確認する
- 実装と設計の差分の有無を特定する
- 差分に対し、A/B/C のいずれかの裁定を与える

以下は **明示的に行わない**。

- pytest・コード・設定の変更
- 「どう直すか」の検討
- 実行結果を用いた是非判断

### 1.4 フェーズ4の完了条件（要約）

フェーズ4は、次の状態に到達したときに完了とする。

- すべての test file について、裁定（A / B / C）が確定している
- 「修正しない判断（C）」が、省略されず設計根拠付きで記録されている
- 差分判断の根拠が、すべて `test_plan_v0.2.0` に紐づいている
- 本書が、次フェーズ（実装修正）への入力資料として利用可能な状態にある

---

## 2. 前提条件と拘束事項

本章は、フェーズ4における差分レビュー作業の
**前提条件および行動拘束**を明文化するものである。

本章に反する作業・判断は、
たとえ合理的に見えてもフェーズ4では行ってはならない。

### 2.1 設計正本に関する前提

- `test_plan_v0.2.0` を、本フェーズにおける **唯一の設計正本**とする
- 他の設計書・過去の実装・運用慣習は、補助情報としても判断根拠に用いない
- 設計の是非・妥当性を再検討しない  
  （設計はフェーズ3で確定済み）

### 2.2 実装に対する拘束

フェーズ4では、以下を行ってはならない。

- pytest の修正・追加・削除
- テストコードの移動・リネーム
- marker・fixture・設定ファイルの変更
- テストを通すための一時的・暫定的調整

実装は **現状を観測対象として固定** し、
変更可能性の検討は次フェーズに委ねる。

### 2.3 判断根拠に関する拘束

- pytest の実行結果（pass / fail / skip）は、差分判断の根拠に使用しない
- 実行環境差・一時的な不安定性を理由に、判断を変更しない
- 「動いている／動いていない」という事実を、
  設計一致・不一致の根拠として扱わない

差分判断の根拠として使用できるのは、
第4章に定義された **設計拘束条件のみ** である。

### 2.4 記述内容に関する拘束

本書には、以下を記載してはならない。

- 実装修正案や具体的な修正方法
- 「こう直したほうがよい」という改善提案
- 将来フェーズを見越した最適化・リファクタ案
- 実装者・過去判断への評価・批評

本書は **裁定記録**であり、提案書・設計書ではない。

### 2.5 フェーズ越境の禁止

- フェーズ4は「差分を確定させる」フェーズであり、
  「差分を解消する」フェーズではない
- 本書はフェーズ5への入力資料であり、
  フェーズ5の作業内容を先取りしない

この拘束は、作業効率や納期よりも優先される。

---

## 3. 差分レビューの進め方（方法論）

本章では、フェーズ4における差分レビューを
**どの順序・単位・形式で進めるか**を定義する。

差分の是非や評価基準は本章では扱わない。
それらは第4章の設計拘束条件にのみ依拠する。

### 3.1 レビュー単位

- 差分レビューは、原則として **1 test file = 1 レビュー** とする
- test file とは、`tests/` 配下の個別 `test_*.py` を指す
- 複数ファイルにまたがる構造的問題が存在する場合でも、
  裁定は必ず **ファイル単位で記録**する

### 3.2 レビュー対象の順序

- レビューは、`appendix_C_relocation_map` に記載された順序に従って実施する
- 任意の順序変更や、重要度による先行レビューは行わない
- 付録Cは、フェーズ3で確定した **唯一の作業順序表**として扱う

### 3.3 差分確認の基本手順

各 test file について、以下の手順で確認を行う。

1. test_plan_v0.2.0 上の想定責務・位置づけを確認する
2. 当該 test file の現状実装を確認する
3. 設計と実装の差分の有無を特定する
4. 差分に対し、A / B / C のいずれかの裁定を与える
5. 裁定理由を、設計根拠に紐づけて記録する

本手順に含まれない確認や判断は行わない。

### 3.4 裁定区分（A / B / C）

差分レビューの結果は、必ず次のいずれかに分類する。

- **A：設計一致（No Action）**  
  実装は test_plan_v0.2.0 と整合しており、
  本フェーズで対応すべき差分は存在しない

- **B：設計差分あり・将来修正対象**  
  実装は設計と差分を持つが、
  本フェーズでは修正せず、次フェーズで対応すべき対象である

- **C：設計差分あり・非修正**  
  実装は設計と差分を持つが、
  設計上の理由により修正対象としないことを明示的に判断する

※ B および C については、必ず判断理由を記録する

### 3.5 記録フォーマットの固定

- 差分レビューの記録は、第5章に定義された定型構造に従う
- 任意の書式変更や、ファイルごとの独自フォーマットは認めない
- 判断理由は、簡潔かつ設計参照可能な形で記述する

本フェーズの成果は、**判断の一貫性**により担保される。

---

## 4. 差分判断に用いる設計拘束条件（チェックリスト）

本章は、フェーズ4において
**差分判断の根拠として使用してよい設計拘束条件を列挙する**。

本章に記載されていない観点・基準・経験則を、
差分判断の根拠として用いてはならない。

### 4.1 レイヤー整合性（Layer 1 / 2 / 3）

- 当該 test file の責務が、
  test_plan_v0.2.0 で定義されたレイヤーに一致しているか
- Layer 1（Contract Tests）が、
  観測・評価・試行の責務を含んでいないか
- Layer 2 / 3 の成果物や振る舞いを、
  pytest により保証しようとしていないか

### 4.2 pytest の責務拘束

- pytest が Contract Test 専用として使用されているか
- 実行結果（pass / fail / skip）に意味論を持ち込んでいないか
- pytest が
  - 観測結果の解釈
  - 評価結果の判定
  - 成果物の完全性保証
  を担っていないか

### 4.3 Gate / Smoke テストの位置づけ

- Gate / Smoke が、
  test_plan_v0.2.0 第4.5章の再配置指針と一致しているか
- Gate が
  - 入口遮断
  - 最小成立条件の確認
  という責務に限定されているか
- Smoke が
  - システム全体の健全性確認
  に用途限定されているか

### 4.4 Failure の意味論に関する拘束

- 「生成されない」「取得できない」ことを、
  failure と同一視していないか
- failure を
  - 品質低下
  - 回答不正
  - 評価不能
  と解釈していないか
- failure が、設計上定義された
  **状態（state）**として扱われているか

### 4.5 F4 / Evaluation Artifacts の取り扱い

- F4 の trial dataset や派生物が、
  pytest の pass / fail 判定に関与していないか
- Evaluation Artifacts が
  - Layer 3 の成果物
  - 非テスト資産
  として扱われているか
- 「生成されない＝不正」という誤解が、
  実装・テストに混入していないか

### 4.6 再配置指針との整合

- フェーズ3で確定した再配置指針と矛盾していないか
- 継続／廃止／移動の判断が、
  再配置指針以外の理由で行われていないか
- 「慣れているから」「以前そうだったから」
  といった理由が判断根拠に含まれていないか

---

※ 本章はチェックリストであり、
  項目の重み付け・優先順位付けは行わない  
※ 差分判断は、該当項目への **合致／不合致の確認結果**として記録する

---

## 5. 個別テスト差分レビュー

### 5.1 tests/test_smoke_llm.py

- 対象ファイル:
  - path: `tests/test_smoke_llm.py`
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）
- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Layer 1（Contract Tests）定義
    - Smoke Test の位置づけ
- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: Layer 1 における保証対象
    - 4.3: Layer 1 における非保証対象
    - 4.5.2: Smoke Test の位置づけ
- 差分の有無: **有**
- 判断: **B（設計差分あり・将来修正対象）**
- 判断理由:
  - 本テストは、UI送信API（Design_ChatPage_submit v0.6）および submit–probe 相関設計（Design_submit_probe_correlation v0.2）を根拠として生成されており、  
    UI送信完了および応答相関の**観測**を行う点は設計意図と整合している
  - 一方で、`correlation_state = "No Evidence"` を FAIL 条件として扱っており、  
    相関状態という**観測結果の意味**を pass / fail 判定に直接結びつけている
  - test_plan_v0.2.0 において Smoke Test（Layer 1）は工程前提の成立確認に限定され、  
    観測結果の意味付けや状態評価は非保証対象とされているため、  
    当該 assertion は設計上の責務境界を越えている
- 非判断事項（本レビューでは扱わない）:
  - correlation_state を用いた assertion の修正方法
  - submit–probe 実装や probe 設計の是非
  - pytest 実行結果やテストの安定性
  - テスト内容の改善・最適化提案

---

#### 補足（位置づけの明確化）

- 本レビューは **Deep Research により特定された設計起源**と
  **test_plan_v0.2.0 の定義**を突き合わせた結果のみを記録している
- 「なぜそう書かれたか」は **Design_ChatPage_submit v0.6 / Design_submit_probe_correlation v0.2** により説明可能
- 「今後どう扱うか」は **フェーズ5（差分解消）** に委譲される

---

### 5.2 tests/rag_entry/test_gate1_entry_minimal.py

- 対象ファイル:
  - path: tests/rag_entry/test_gate1_entry_minimal.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Gate / Entry テストの位置づけ
    - Layer 2（Behavior / 観測）の扱い

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象の整理
    - 4.3: 非保証対象の整理
    - 4.5: Gate / Entry 系テストの再配置指針

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは Gate1 Entry における最小確認として、
    UI送信後に Raw Answer（回答テキスト）および
    Execution Context（chat_id / submit_id 等）が
    取得可能であることのみを確認している
  - これは Design_ci_rag_entry_v0.1 における
    MUST-2（実行条件の記録）および
    MUST-3（Raw / Context / Summary 構造の存在確認）
    に対応する観測的検証であり、
    応答内容の意味評価や品質判断は行っていない
  - test_plan_v0.2.0 において Gate 系テストは
    「入口としての成立性を観測する」位置づけであり、
    本テストはその範囲に収まっているため、
    設計との差分は認められない

- 非判断事項（本レビューでは扱わない）:
  - Golden 資産保護（MUST-4）を本テストで扱うべきかどうか
  - Execution Context 内の個別パラメータ
    （knowledge_source_id 等）を検証対象に含める是非
  - pytest 実行結果やテストの網羅性評価
  - 実装修正方法や改善提案

---

### 5.3 tests/rag_entry/test_gate1_schema_entry.py

- 対象ファイル:
  - path: tests/rag_entry/test_gate1_schema_entry.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Gate / Entry テストの位置づけ
    - Layer 2（Behavior / 観測）の扱い
    - F4 試金石データの位置づけ

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象の整理
    - 4.3: 非保証対象の整理
    - 4.5: Gate / Entry 系テストの再配置指針
    - 6.5: F4 trial dataset の正式な引退（設計上）

- 差分の有無: 有

- 判断: B（設計差分あり・将来修正対象）

- 判断理由:
  - 本テストは Design_ci_rag_entry_v0.1 付録Aに定義された
    Gate1 CI のスキーマ検証チェックリスト
    （S-01〜05, R-01〜02, C-01〜05, D-01〜02, G-01〜03）
    を pytest テストとして忠実に実装したものであり、
    raw_evidence / execution_context / derived_summary
    といった各レイヤ構造の存在確認を行っている点は、
    当時の設計意図と一致している
  - 一方で test_plan_v0.2.0 では、
    F4 試金石データおよびその派生構造は
    Evaluation Artifacts（非テスト対象）として整理され、
    pytest による pass / fail 判定の対象外と位置づけられている
  - 本テストは F4 試金石データの JSON 構造を
    pytest により機械的に検証しており、
    Gate / Entry テストの観測範囲を超えて
    Evaluation Artifacts をテスト対象として扱っている点で、
    現行設計（test_plan_v0.2.0）との間に
    責務境界の不整合が生じている

- 非判断事項（本レビューでは扱わない）:
  - F4 試金石データのスキーマ検証を
    どのレイヤで担保すべきかという再設計方針
  - Golden 資産保護（G-01〜03）検出ロジックの実装是非
  - pytest 実行結果やスキーマ検証の網羅性評価
  - assertion の具体的変更案やテストの移設方法

---

### 5.4 tests/f4/test_f4_case1_writer.py

- 対象ファイル:
  - path: tests/f4/test_f4_case1_writer.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第6章
    - Evaluation Artifacts（非テスト）の位置づけ
    - F4 trial dataset の扱い

- 参照設計文書:
  - test_plan_v0.2.0
    - 6.5: F4 trial dataset の正式な引退（設計上）
    - 6.6: Evaluation Artifacts の保存・利用方針

- 差分の有無: 有

- 判断: B（設計差分あり・将来修正対象）

- 判断理由:
  - 本テストは Design_rag_f4_eval_v0.1 に定義された
    Case1（Baseline）シナリオに沿い、LLM への質問実行、
    回答取得、Evidence 用語の有無判定および
    F4 結果ログ（Markdown）の書き出しを行っている
  - また、Design_pytest_f4_results_writer_v0.1.2 に基づき、
    Execution Context（login_identity が unverified であること）
    を結果ログ内に記録している点は、当時の設計意図と整合している
  - 一方で test_plan_v0.2.0 では、F4 試行結果および
    その派生ログは Evaluation Artifacts と位置づけられ、
    pytest による pass / fail 判定やテスト保証の対象外とされている
  - 本スクリプトは F4 評価結果の生成・内容確認を
    pytest テストとして実行しており、
    現行設計における「非テスト成果物」を
    テストスイート内で検証対象として扱っている点で、
    責務境界に差分が存在する

- 非判断事項（本レビューでは扱わない）:
  - F4 Case1 の評価基準（Evidence/Hallucination 等）の妥当性
  - F4 結果ログのフォーマット詳細や将来版仕様への対応
  - ログ出力処理の実装修正方法
  - pytest 実行結果やテストの再現性・網羅性評価

---

### 5.5 tests/f4/test_f4_case2_writer.py

- 対象ファイル:
  - path: tests/f4/test_f4_case2_writer.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第6章
    - Evaluation Artifacts（非テスト）の位置づけ
    - F4 trial dataset の扱い

- 参照設計文書:
  - test_plan_v0.2.0
    - 6.5: F4 trial dataset の正式な引退（設計上）
    - 6.6: Evaluation Artifacts の保存・利用方針

- 差分の有無: 有

- 判断: B（設計差分あり・将来修正対象）

- 判断理由:
  - 本テストは Design_rag_f4_eval_v0.1 に定義された
    Case2（条跨ぎ＋附則参照）シナリオに沿い、
    回答取得および HTML / Markdown 差異観察のための
    F4 結果ログ生成を行っている
  - また、Design_pytest_f4_results_writer_v0.1.2 に基づき、
    profile（html / markdown）を明示指定し、
    その値が結果ログに記録される前提で実行されている点は、
    当時の設計意図と整合している
  - 一方で test_plan_v0.2.0 では、
    F4 試行結果および派生ログは
    Evaluation Artifacts として整理され、
    pytest による pass / fail 判定や
    テスト保証の対象外と位置づけられている
  - 本スクリプトは F4 Case2 の評価結果生成と
    その一部内容確認を pytest テストとして実行しており、
    現行設計における責務境界（非テスト成果物）と
    不整合が生じている

- 非判断事項（本レビューでは扱わない）:
  - Case2 における差分観察の成否基準の定義
  - Golden 質問プールを使用しない運用判断の是非
  - F4 結果ログの出力形式や将来版仕様への対応
  - pytest 実行結果、テスト網羅性、実装修正方法

---

### 5.6 tests/f4/test_f4_case3_writer.py

- 対象ファイル:
  - path: tests/f4/test_f4_case3_writer.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第6章
    - Evaluation Artifacts（非テスト）の位置づけ
    - F4 trial dataset の扱い

- 参照設計文書:
  - test_plan_v0.2.0
    - 6.5: F4 trial dataset の正式な引退（設計上）
    - 6.6: Evaluation Artifacts の保存・利用方針

- 差分の有無: 有

- 判断: B（設計差分あり・将来修正対象）

- 判断理由:
  - 本テストは Design_rag_f4_eval_v0.1 に定義された
    Case3（義務・禁止事項の全抽出／網羅性）シナリオに沿い、
    回答取得後、特定キーワード（「義務」「〜してはならない」等）
    の含有有無を機械的に確認し、F4 結果ログを Markdown として出力している
  - また、Design_pytest_f4_results_writer_v0.1.2 の原則
    （一次事実のみを記録し、解釈は行わない）に従い、
    LLM 応答をそのまま観測結果としてログ化している点は、
    当時の設計意図と整合している
  - 一方で test_plan_v0.2.0 では、
    F4 試行結果および派生ログは
    Evaluation Artifacts として整理され、
    pytest による pass / fail 判定や
    テスト保証の対象外と位置づけられている
  - 本スクリプトは F4 Case3 の評価結果生成および
    一部内容確認を pytest テストとして実行しており、
    現行設計における「非テスト成果物」を
    テストスイート内で検証対象として扱っている点で、
    責務境界に差分が存在する

- 非判断事項（本レビューでは扱わない）:
  - 義務／禁止事項の完全性基準や網羅性評価方法の妥当性
  - キーワード検出ロジックの実装修正方法
  - F4 結果ログ形式の将来版（v0.2以降）への対応方針
  - pytest 実行結果、テスト網羅性、改善・最適化提案

---

### 5.7 tests/_legacy/rag/test_rag_basic_ask_v0_2.py

- 対象ファイル:
  - path: tests/_legacy/rag/test_rag_basic_ask_v0_2.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - レイヤーモデル（Layer 1/2/3）
    - Legacy テストの扱い方針

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象の整理
    - 4.3: 非保証対象の整理
    - 4.5: 既存テストの再配置指針（Legacy の位置づけ）

- 差分の有無: 有

- 判断: C（設計差分あり・非修正）

- 判断理由:
  - 本テストは Test Plan v0.1 に基づく Basic RAG テストであり、
    旧 ask() API（ChatPage.ask v0.5 相当）を用いて
    単発質問の同期的応答取得と、
    期待キーワード全含有による pass / fail 判定を行っている
  - test_plan_v0.2.0 では、submit–probe 分離後の
    契約テスト（Layer 1）および観測テスト（Layer 2）が
    正式なテスト体系とされており、
    ask() API 依存・意味評価（期待語句全含有）に基づく
    合否判定は現行設計の保証対象外である
  - 本スクリプトは submit / probe 移行前の挙動を
    参照・保存するための **Legacy テスト** としての性格が明確であり、
    現行設計に合わせて修正・再配置することは
    設計上の目的に合致しない
  - 以上より、設計との差分は存在するが、
    非修正（Legacy として保持）と裁定する

- 非判断事項（本レビューでは扱わない）:
  - ChatPage.ask 方式を submit / probe 方式へ移行すべきかの是非
  - expected_keywords による合否判定ロジックの妥当性
  - YAML テストデータの網羅性や品質評価
  - pytest 実行結果や安定性、改善・最適化提案

---

### 5.8 tests/diagnostic/test_profile_resolution.py

- 対象ファイル:
  - path: tests/diagnostic/test_profile_resolution.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - レイヤーモデル（Contract / Behavior / 非テスト）
    - 診断・補助スクリプトの扱い方針

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象の整理
    - 4.3: 非保証対象の整理
    - 4.5: テスト再配置指針（診断系の位置づけ）

- 差分の有無: 有

- 判断: C（設計差分あり・非修正）

- 判断理由:
  - 本スクリプトは env_loader によるプロファイル解決結果を
    **観察・出力**することを目的とした診断用テストであり、
    正否を厳密に判定する契約（Contract）テストではない
  - test_plan_v0.2.0 において、
    pytest による保証対象は Contract Tests に限定されており、
    環境選択の結果確認のみを行う診断用途は
    テスト保証の対象外として整理されている
  - 本スクリプトは profile_cfg が None でないことのみを確認し、
    選択結果の正当性や一致性を合否判定に用いていないため、
    現行設計下では **非保証・診断用途**としての性格が明確である
  - 以上より、設計との差分は存在するが、
    診断用スクリプトとして保持することが妥当であり、
    修正・再配置は行わないと裁定する

- 非判断事項（本レビューでは扱わない）:
  - 選択されたプロファイルが期待どおりかの正確性評価
  - env_loader の実装是非やエラー時挙動
  - pytest 実行結果の成否や診断テストの有用性評価
  - 実装修正方法や改善・最適化提案

---

### 5.9 tests/rag/test_rag_basic_v0_1.py

- 対象ファイル:
  - path: tests/rag/test_rag_basic_v0_1.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - レイヤーモデル（Layer 1/2/3）
    - Legacy / 旧Basic RAGテストの扱い方針

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象の整理
    - 4.3: 非保証対象の整理
    - 4.5: 既存テストの再配置指針（Legacy の位置づけ）

- 差分の有無: 有

- 判断: C（設計差分あり・非修正）

- 判断理由:
  - 本テストは Test Plan v0.1 に基づく Basic RAG テストであり、
    YAML 定義の質問ケースに対して
    期待キーワード全包含を pass / fail 判定とする
    **意味評価型**の合否判定を行っている
  - 実装は ChatPage.submit v0.6 と
    probe v0.2 を用いた submit–probe 構成であるが、
    合否判定の基準自体は v0.1 時代の
    Basic RAG テスト仕様（期待語句一致）に依存している
  - test_plan_v0.2.0 では、
    pytest による保証は Contract Tests に限定され、
    回答内容の意味評価や期待語句包含判定は
    保証対象外（Layer 3 / Evaluation）として整理されている
  - 本スクリプトは旧 Basic RAG テスト体系を
    参照・保存するための **Legacy テスト**としての性格が明確であり、
    現行設計に合わせた修正や再配置は
    設計上の目的に合致しない

- 非判断事項（本レビューでは扱わない）:
  - 期待キーワードによる合否判定方式の妥当性
  - YAML 質問ケースの設計根拠や網羅性評価
  - submit–probe 構成における例外処理の適切性
  - pytest 実行結果や安定性、改善・最適化提案

---

### 5.10 tests/rag/test_rag_advanced_v0_1.py

- 対象ファイル:
  - path: tests/rag/test_rag_advanced_v0_1.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - レイヤーモデル（Layer 1/2/3）
    - Legacy / 旧Advanced RAGテストの扱い方針

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象の整理
    - 4.3: 非保証対象の整理
    - 4.5: 既存テストの再配置指針（Legacy の位置づけ）

- 差分の有無: 有

- 判断: C（設計差分あり・非修正）

- 判断理由:
  - 本テストは Test Plan v0.1 に基づく Advanced RAG テストであり、
    複数ターンの対話シナリオに対して
    期待語句の包含および禁止語句の非混入を
    pass / fail 判定に用いる **意味評価型** の合否判定を行っている
  - 背景として Design_rag_f4_eval_v0.1 の評価指標
    （重要語句網羅／不適表現検出）に対応する簡易確認を含むが、
    これらは test_plan_v0.2.0 では
    Evaluation（Layer 3）に整理され、pytest の保証対象外である
  - また、複数ターン（multi-turn）対話の逐次実行は
    現行の Contract / Behavior テスト体系には含まれておらず、
    旧来の Advanced RAG 検証手法としての性格が明確である
  - 以上より、設計との差分は存在するが、
    旧仕様を保存・参照するための **Legacy テスト** として保持し、
    現行設計に合わせた修正・再配置は行わないと裁定する

- 非判断事項（本レビューでは扱わない）:
  - multi-turn 対話をテスト体系に含める是非
  - 期待語句／禁止語句による合否判定の妥当性
  - YAML シナリオ定義の網羅性や設計根拠
  - pytest 実行結果、安定性、改善・最適化提案

---

### 5.11 tests/f9/a/binding/test_ordinance_binder.py

- 対象ファイル:
  - path: tests/f9/a/binding/test_ordinance_binder.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Layer 1（Contract Tests）の定義
    - ドメインオブジェクトの不変条件（契約）検証

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象（Contract Tests）
    - 4.3: 非保証対象の整理

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは F9-A フェーズ A-2（BindOrdinanceID）における
    **契約レベルの不変条件**（ordinance_id の保持、
    question_templates の同一性）のみを検証している
  - 検証内容は、Spec_F9-A_Implementation_v0.1r に定義された
    A-2 の責務（条例IDの束縛とテンプレ群の保持）と一致し、
    また Spec_F9-A_Question_Set_and_Binding_v0.1r に示された
    OrdinanceBinding 構造の最小保証条件に合致している
  - 回答生成・評価・解釈といった非契約領域には踏み込まず、
    純粋なデータ構造の整合性のみを assert しているため、
    test_plan_v0.2.0 における Layer 1（Contract Tests）の
    役割定義と整合している

- 非判断事項（本レビューでは扱わない）:
  - A-2 以降（A-3 / A-4）工程への引き継ぎの妥当性
  - OrdinanceBinding データクラスの実装詳細（frozen 等）
  - pytest 実行結果や統合テスト時の挙動
  - 実装修正方法や改善・最適化提案

---

### 5.12 tests/f9/a/question/test_template_validator.py

- 対象ファイル:
  - path: tests/f9/a/question/test_template_validator.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Layer 1（Contract Tests）の定義
    - 入力データ（質問テンプレート）の契約条件検証

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 保証対象（Contract Tests）
    - 4.3: 非保証対象の整理

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは F9-A フェーズ A-1（ValidateTemplate）における
    契約条件「質問テンプレートは抽象表現のみを許容する」
    を単体で検証している
  - 抽象表現のみのテンプレ集合が正常通過し、
    具体的な条番号・条例IDを含むテンプレで
    TemplateValidationError が送出されることを確認する構成は、
    Spec_F9-A_Implementation_v0.1r に定義された
    A-1 の責務および OK / NG 条件と一致している
  - 回答生成・評価・解釈などの非契約領域には踏み込まず、
    入力データの形式的妥当性のみを assert しているため、
    test_plan_v0.2.0 における Layer 1（Contract Tests）の
    役割定義と整合している

- 非判断事項（本レビューでは扱わない）:
  - エラーメッセージ文言の妥当性や表現統一
  - 抽象表現ルール境界（正規表現等）の設計是非
  - CSV 編集時のユーザビリティや網羅性
  - pytest 実行結果や実装修正方法、改善・最適化提案

---

### 5.13 tests/f9/a/question_set/test_csv_loader.py

- 対象ファイル:
  - path: tests/f9/a/question_set/test_csv_loader.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Layer 1（Contract Tests）
    - 入力資産（質問セット）の形式的妥当性と工程間接続保証

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: Contract Tests の保証範囲
    - 4.3: 非保証対象（内容評価・意味解釈の除外）

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは F9-A フェーズ A-0（質問セットCSVロード）の責務である
    「CSVから質問テンプレ行を構造化データとして読み込む」
    ことのみを検証しており、内容の正否や抽象度判定には踏み込んでいない
  - CSV → QuestionTemplateRow → question_text 配列という変換結果が、
    後続の A-1（ValidateTemplate）にそのまま引き渡せることを確認しており、
    Spec_F9-A_Question_Set_and_Binding_v0.1r に定義された
    **A-0 / A-1 の責務分離と接続条件**に一致している
  - CSVヘッダおよび行構造は、設計書で確定している
    質問セットCSV仕様の範囲内で使用されており、
    形式的な契約条件（構造・型・順序）を満たすかのみを
    機械的に検証するテストとなっている
  - 入力資産の読み込み可否という Contract レイヤの検証に限定されているため、
    test_plan_v0.2.0 における Layer 1 の位置づけと整合する

- 非判断事項（本レビューでは扱わない）:
  - CSVカラム名の命名方針（text / question_text の差異）
  - CSV内容の意味的妥当性や質問文の品質
  - A-0工程のエラーハンドリング設計
  - 実装修正方法、assertion の追加・変更案
  - pytest 実行結果や改善・最適化提案

---

### 5.14 tests/f9/a/resolution/test_auto_resolver.py

- 対象ファイル:
  - path: tests/f9/a/resolution/test_auto_resolver.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Layer 2（Deterministic Resolution / Mechanical Rules）
    - 人手判断を伴わない機械的解決の成立条件

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: Deterministic Resolution の位置づけ
    - 4.4: 未解決時の次工程（人手／別フェーズ委譲）

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは F9-A フェーズ A-3（AutoResolve）の責務である
    「条・項参照が**一意に決まる場合のみ**機械的に具体化する」
    という設計要件に厳密に限定された検証を行っている
  - 入力として条例構造（article一覧・paragraph一覧）を与え、
    質問テンプレ内の抽象参照（第○条／第○条第○項）が
    **候補が一つに定まるケースでのみ**具体番号へ置換されることを確認しており、
    Spec_F9-A_Implementation_v0.1r の AutoResolve 定義と一致する
  - 出力として article / paragraph（該当なし時は None）という
    partial_resolution 構造を検証しており、
    設計で定義された「部分解決状態の表現形式」を逸脱していない
  - 複数候補時の曖昧解決や例外系を扱っていない点も、
    本テストが**A-3の正常系・機械的解決成立条件のみ**を対象とする
    単体テストであるという設計上の切り分けと整合している

- 非判断事項（本レビューでは扱わない）:
  - 複数候補が存在する場合の例外ポリシーやエラー型の妥当性
  - AutoResolve内部アルゴリズムの詳細（探索順・優先順位）
  - 条例データ品質が解決結果に与える影響
  - 実装修正方法、assertion の追加・変更案
  - pytest 実行結果や改善・最適化提案

---

### 5.15 tests/f9/a/resolution/test_user_input_resolver.py

- 対象ファイル:
  - path: tests/f9/a/resolution/test_user_input_resolver.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - Layer 3（Human-in-the-loop Resolution）
    - 機械的解決不能時の最終確定責務

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.3: 人手介入による解決の位置づけ
    - 4.4: 未確定状態を残さない設計原則

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは F9-A フェーズ A-4（User Input Resolution）の責務である
    「AutoResolve（A-3）で未確定となった場合でも、**必ず人手入力により確定させる**」
    という設計原則を直接検証している
  - ResolutionRequired 例外が保持する候補情報（article候補、paragraph候補）を入力として、
    人工的に与えたユーザー入力（article=3, paragraph=2）により
    **完全に確定した参照（article/paragraph）が返ること**を確認しており、
    Spec_F9-A_Implementation_v0.1r の PromptUserIfNeeded（A-4）設計と整合する
  - 未確定状態のまま処理が終了しない点、ユーザー入力が正規の確定経路として
    実装・検証されている点は、
    test_plan_v0.2.0 における「最終確定責務は人手で担保する」という位置づけと一致している
  - UXや対話ループの詳細に踏み込まず、
    **A-4の純粋な論理的責務（入力→確定）**に限定している点も、
    単体テストとしての設計境界を逸脱していない

- 非判断事項（本レビューでは扱わない）:
  - 実際の対話UIやCLIでの入力フロー設計・ユーザビリティ
  - 不正入力や再入力ループ等の異常系網羅性
  - AutoResolve（A-3）からA-4への結合テスト全体の妥当性
  - 実装修正方法、assertion の具体的変更案
  - pytest 実行結果や改善・最適化提案

---

### 5.16 tests/f9/a/test_a1_a2_integration.py

- 対象ファイル:
  - path: tests/f9/a/test_a1_a2_integration.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - F9-A フェーズ構成
    - A-1（ValidateTemplate）→A-2（BindOrdinanceID）の連続適用

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.1: 質問テンプレ検証（抽象表現のみ）
    - 4.2: 条例IDバインディング（テンプレ非変質）

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは F9-A における **A-1→A-2 の責務分離かつ連続適用**という設計前提を、
    正常系に限定して検証している
  - A-1（validate_question_templates）の出力がそのまま
    A-2（bind_ordinance_id）の入力として利用可能であること、
    かつ A-2 の出力である OrdinanceBinding において
    - ordinance_id が指定値と一致すること
    - question_templates が **内容変更なく保持**されていること
    を確認しており、設計書で定義された
    「検証とバインディングは分離されるが、データ構造は連続的に受け渡される」
    という原則と一致する
  - 本テストは工程間インターフェースの整合性確認に焦点を当てており、
    個別工程の詳細検証（A-1単体 / A-2単体）を再実装していない点も、
    結合テストとしての設計境界を逸脱していない

- 非判断事項（本レビューでは扱わない）:
  - A-1 不合格時の例外伝播や A-2 未実行保証の検証
  - OrdinanceBinding 内部構造（binding詳細）の完全一致検証
  - A-2 以降（A-3/A-4）への引き渡し可否
  - 実装修正方法
  - assertion の具体的変更案
  - pytest 実行結果
  - 改善・最適化提案

---

### 5.17 tests/f9/a/test_a2_a3_integration.py

- 対象ファイル:
  - path: tests/f9/a/test_a2_a3_integration.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - F9-A フェーズ構成
    - A-2（BindOrdinanceID）→A-3（AutoResolve）の連続適用

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.2: 条例IDバインディング
    - 4.3: 条・項の自動解決（AutoResolve）

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは、F9-A における **A-2→A-3 の工程連携**という設計前提に対し、
    正常系の代表ケース（候補が一意に決まる場合）を用いて検証している
  - A-2で生成した OrdinanceBinding を入力として、
    A-3（resolve_article_reference）が条例構造（article=3, paragraph=2のみ）を根拠に
    質問テンプレ中の参照を **機械的に一意決定**できることを確認しており、
    設計書で定義された AutoResolve の責務（候補が一意なら自動確定）と一致する
  - 解決結果として、
    - 「第○条」質問では article=3, paragraph=None
    - 「第○条第○項」質問では article=3, paragraph=2
    が得られる点は、設計上の **partial_resolution 出力形式**および
    「未確定を残さない」制約に合致している
  - 本テストは工程境界（A-2→A-3）のデータ受け渡しと解決成立のみを扱っており、
    アルゴリズム詳細や異常系に踏み込んでいない点も、
    結合テストとしての設計スコープを逸脱していない

- 非判断事項（本レビューでは扱わない）:
  - 複数候補存在時の ResolutionRequired 発生条件や例外内容の妥当性
  - 条例構造が複雑な場合の AutoResolve 成功率や優先順位
  - A-3→A-4（ユーザー入力解決）との結合挙動
  - 実装修正方法
  - assertion の具体的変更案
  - pytest 実行結果
  - 改善・最適化提案

---

### 5.18 tests/f9/a/test_a3_a4_integration.py

- 対象ファイル:
  - path: tests/f9/a/test_a3_a4_integration.py
  - revision:
    - checked_at: 2026-01-11
    - （commit: 不確定）

- 判断に用いた設計スコープ:
  - test_plan_v0.2.0 第4章
    - F9-A フェーズ構成
    - A-3（AutoResolve）→ A-4（User Input Resolve）の解決保証フロー

- 参照設計文書:
  - test_plan_v0.2.0
    - 4.3: 条・項の自動解決（AutoResolve）
    - 4.4: ユーザー入力による最終解決（解決保証）

- 差分の有無: 無

- 判断: A（設計一致・No Action）

- 判断理由:
  - 本テストは、F9-A における **A-3→A-4 の解決保証フロー**を、
    「自動解決不能ケース」を起点に一貫して検証している
  - A-3（auto_resolve_article_paragraph）において、
    「第○条のみ指定」の質問が **複数候補を持つため未確定**となり、
    ResolutionRequired が送出される点は、
    設計書における「候補が一意に定まらない場合はユーザー入力へ遷移」
    という発火条件と一致する
  - ResolutionRequired が保持する
    article_candidates および paragraphs_by_article が
    想定どおり提示されることを検証しており、
    これは設計上の「候補提示」責務を事実ベースで裏づけている
  - 続く A-4（resolve_by_user_input）において、
    ユーザー入力（article=3, paragraph=2）により
    **必ず完全解決される**ことを確認しており、
    設計で FIX とされている
    「未確定のまま終了してはならない（解決保証）」ポリシーと整合している
  - 自動解決失敗 → ユーザー介入 → 最終確定、という
    工程境界の責務分離と連携が、設計意図どおり機能していることを
    最小限の正常系シナリオで確認している

- 非判断事項（本レビューでは扱わない）:
  - ResolutionRequired 例外クラスの設計妥当性やAPI安定性
  - 対話的UIにおける候補提示方法・入力UX
  - 複数回誤入力時の再入力制御やエラーハンドリング
  - 実装修正方法
  - assertion の具体的変更案
  - pytest 実行結果
  - 改善・最適化提案

---

### 5.19 フェーズ5 総括（判定結果の整理と次フェーズへの引き渡し）

#### 5.19.1 総括の目的

本節は、フェーズ5において実施した  
**全テストスクリプトの差分判定（5.1〜5.18）を総括し、  
設計上どの論点が確定し、どの論点が次フェーズへ持ち越されるかを明確化する**  
ための裁定記録である。

本節においても、以下は行わない。

- 実装修正方針の提示
- 優先順位付けや工数見積
- フェーズ6の詳細設計

あくまで「**ここまでで何が確定したか**」のみを整理する。

---

#### 5.19.2 判定結果の集計（事実）

フェーズ5で判定対象としたテストスクリプトは **全18件** であり、  
その判定内訳は以下のとおりである。

- **A（設計一致・No Action）**: 11件  
- **B（設計差分あり・将来修正対象）**: 5件  
- **C（設計差分あり・非修正）**: 2件  

この時点で、

- **未判定のテストスクリプトは存在しない**
- **すべての判定は test_plan_v0.2.0 に基づき記録済み**

である。

---

#### 5.19.3 A判定（設計一致）の特徴整理

A判定となったスクリプト群には、明確な共通点がある。

- **責務が単一フェーズ・単一レイヤに限定されている**
- pytest が
  - 契約条件（Contract）
  - 機械的に一意決定できる処理
  - 人手入力による最終確定
  のいずれかに厳密に閉じている
- 「意味評価」「品質評価」「結果解釈」を一切担っていない

特に F9-A 系（A-0〜A-4）の

- 単体テスト
- 隣接フェーズ結合テスト

は、**設計時点の責務分離がそのままコードに反映されており、  
test_plan_v0.2.0 の再定義と衝突していない**ことが確認された。

→ フェーズ6において、これらは **変更不要な安定基盤** として扱える。

---

#### 5.19.4 B判定（将来修正対象）の構造的共通点

B判定となったスクリプトは、内容の是非ではなく  
**「pytest に担わせている責務の位置づけ」が設計とズレている**点で共通している。

具体的には、

- F4 試行結果や派生ログを
  - pytest の pass / fail 判定対象
  - テスト保証資産
  として扱っている
- 観測結果や生成物に対し、
  **pytest 内で意味論的な解釈を与えている**

これらは、

- 過去設計（v0.1 系）では合理的だった
- test_plan_v0.2.0 では **Evaluation Artifacts（非テスト）** に再定義された

という **設計改訂に起因する差分** である。

重要な点として、

- B判定は「実装が間違っている」という意味ではない
- 「**今の設計正本では、その責務を pytest に置かない**」という裁定である

→ フェーズ6では、  
「消す／移す／pytest から切り離す」いずれかの整理が必要になるが、  
**本フェーズでは判断済み・未実施** として確定した。

---

#### 5.19.5 C判定（非修正）の位置づけ明確化

C判定となったスクリプトは、

- Legacy テスト
- 診断・観測補助スクリプト

としての性格が明確であり、  
**現行設計に合わせて修正すること自体が設計意図に反する** と判断された。

共通点は以下の通り。

- 旧API・旧テスト哲学の保存価値がある
- 現行設計（submit–probe / Layer分離）の保証対象ではない
- しかし「削除すべきゴミ」でもない

→ これらは **設計上“直さない”ことが正しい対象** として明示的に確定した。

この「直さない判断」が  
理由付きで文書化された点は、フェーズ5の重要な成果である。

---

#### 5.19.6 フェーズ5完了の確認

以下がすべて満たされている。

- フェーズ5で判定すべき全スクリプトが網羅されている
- 各スクリプトに A / B / C の裁定が付与されている
- B / C 判定には、必ず設計根拠が記録されている
- 「将来直す」「直さない」が混在せず、区別されている
- 実装修正・提案・感想が混入していない

よって、

**フェーズ5（差分判定フェーズ）は完了状態に到達した**  
と判断できる。

---

#### 5.19.7 次フェーズへの引き渡し事項（事実のみ）

フェーズ6に引き渡される確定事項は以下である。

- 修正対象は **B判定のスクリプト群のみ**
- C判定は「保持・非修正」が設計上確定
- A判定は「安定基盤」として前提にできる
- フェーズ6は
  - test_plan_v0.2.0
  - 本書（Implementation_Diff_Review_v0.2.0）
  を **入力正本**として開始される

本節では、  
「フェーズ6で何をどう直すか」は一切定義していない。

それは、次フェーズの責務である。

---

## 6. 横断的に見えた傾向と注意点

### 6.1 設計逸脱のパターン整理（事実ベース）

フェーズ5（5.1〜5.18）の判定結果を横断的に整理すると、
設計逸脱（B/C判定）には明確なパターンが存在する。

以下は、**実装内容ではなく「逸脱の型」**として整理したものである。

---

#### パターン1：pytest が「評価主体」になっている

該当傾向：

- F4 系テスト（Case1〜3）
- 一部 RAG Advanced / Basic テスト

事実として観測された状態：

- pytest が
  - 回答内容の妥当性
  - Evidenceの十分性
  - 差分の意味解釈
  を pass / fail の根拠として扱っている
- ログやMarkdown出力が
  「観測結果」ではなく
  「テスト保証対象」として扱われている

設計との関係：

- test_plan_v0.2.0 では
  - pytest = **契約・存在・機械的一貫性の検証**
  - 評価・解釈 = **テスト外アーティファクト**
  と明確に再定義されている
- この再定義と **責務レイヤが不整合** になっているケースが B 判定となった

※ 内容が誤っているわけではなく、
  「置き場所が変わった」ことによる逸脱である。

---

#### パターン2：旧設計（v0.1系）のテスト思想がそのまま残存

該当傾向：

- _legacy 配下のテスト
- ask() API 前提の Basic / Advanced RAG テスト

事実として観測された状態：

- submit–probe 分離以前の
  - DOM 完了検知
  - 同期 ask API
  を前提としたテスト構造
- expected_keywords 全含有 = PASS という
  **旧 Test Plan v0.1 の合格基準**を保持

設計との関係：

- 現行設計ではこれらは
  - 保証対象外
  - ただし削除対象でもない
  という位置づけに変更されている
- そのため C 判定（非修正）として整理された

---

#### パターン3：診断・観測目的テストの性格が明確

該当傾向：

- profile_resolution
- 環境・設定確認系テスト

事実として観測された状態：

- pass / fail よりも
  **ログ出力と観察**が主目的
- assertion は最小限（Noneでない等）

設計との関係：

- これらは test_plan_v0.2.0 上でも
  「非機能・診断補助」として暗黙に許容されている
- 設計逸脱ではなく、**役割が異なるテスト**としてAまたはC判定

---

### 6.2 将来修正時の注意点（提案ではない）

以下は「こう直すべき」という提案ではない。  
**フェーズ6以降で判断を誤らないための前提条件整理**である。

---

#### 注意点1：pytest に「意味」を戻さないこと

事実として確定した点：

- test_plan_v0.2.0 において
  pytest は **意味評価を担わない**
- B 判定はすべて
  「意味を pytest に置いている」ことが原因

注意点：

- フェーズ6での修正作業において
  - assertion を増やす
  - チェックを厳密化する
  方向に進むと、
  **再び同じ逸脱を生む可能性がある**

---

#### 注意点2：「残す」と「正す」を混同しないこと

事実として確定した点：

- C 判定は
  - 技術的負債ではなく
  - **設計上の保存判断**
- Legacy テストは
  「直さない」ことが結論

注意点：

- フェーズ6で整理を進める際に
  - 一律に現行設計へ合わせる
  - すべてを最新APIに寄せる
  という判断は、
  **フェーズ5の裁定を覆す行為**になる

---

#### 注意点3：「評価したい気持ち」と設計を切り離すこと

事実として観測された傾向：

- F4 系テストは
  - 観測としては非常に価値が高い
  - しかし pytest としては過剰

注意点：

- 「せっかく取っているから」
- 「意味があるから」
という理由で pytest に残そうとすると、
**設計境界が再び曖昧になる**

価値があることと、  
pytest に置くべきことは、別である。

---

### 6.3 フェーズ6への前提整理（確認）

この時点で確定している前提は以下。

- 設計逸脱は「型」として整理済み
- 修正対象は B 判定のみ
- C 判定は非修正が正
- pytest の役割境界は再定義済み

これらを前提として、
フェーズ6では

- **何を pytest から外すか**
- **何を pytest に残すか**
- **それをどう文書上で表現するか**

が初めて議論可能になる。

本節は、そのための「地ならし」である。

---

### 6.4 B 判定テストの横断再分類（設計逸脱タイプ別）

本節では、フェーズ5で **B 判定**となったテストスクリプトのみを対象とし、
6.1 で整理した「設計逸脱パターン」に基づいて再分類する。

目的は、

- B 判定の理由を **個別事情ではなく型として把握**すること
- フェーズ6以降での作業単位（束ね・切り出し）を可能にすること
である。

---

#### B-α：pytest が「評価主体」になっている型

**逸脱の本質**  
pytest が「存在確認・契約検証」を越えて、
回答内容や意味的妥当性を pass / fail の根拠としている。

**該当スクリプト（代表）**

- tests/f4/test_f4_case1_writer.py
- tests/f4/test_f4_case2_writer.py
- tests/f4/test_f4_case3_writer.py

**共通の事実**

- 回答テキスト中の語句出現を assertion に使用
- F4 ログ（Markdown）が pytest の保証対象になっている
- 観測・記録と評価の境界が pytest 内で混在

**設計との不一致点**

- test_plan_v0.2.0 では F4 は「評価可能データ生成」であり、
  pytest は「生成が成立したか」のみを担う
- 評価（Evidence / Hallucination 等）は pytest 外工程と定義されている

---

#### B-β：旧テスト思想を新アーキテクチャに部分適用した型

**逸脱の本質**  
旧設計（v0.1系）のテスト合格基準を、
submit–probe 分離後の構造に載せ替えている。

**該当スクリプト（代表）**

- tests/rag/test_rag_basic_v0_1.py
- tests/rag/test_rag_advanced_v0_1.py

**共通の事実**

- expected_keywords 全含有 = PASS という旧基準を保持
- submit→probe 構造には適合しているが、
  **合否判定思想は旧来のまま**

**設計との不一致点**

- test_plan_v0.2.0 では
  「回答内容を pytest で保証しない」方針が明示されている
- 新旧設計の“混在”が B 判定理由

---

#### B-γ：pytest の役割を超えた「意味保証」を試みている型

**逸脱の本質**  
pytest が「意味の正しさ」や「網羅性」を
暗黙に保証している。

**該当スクリプト（代表）**

- （F4 系と Advanced RAG に重複）

**共通の事実**

- 「すべて含まれている」「禁止語がない」ことを PASS 条件にしている
- 実際には **人手評価前提の観測データ**である

**設計との不一致点**

- pytest は意味評価を行わない、という役割分離と衝突
- 価値は高いが、pytest に置く責務ではない

---

### 6.4.1 再分類結果のまとめ（事実）

- B 判定はすべて
  **「実装品質」ではなく「責務レイヤ不一致」**に起因
- 逸脱はランダムではなく、
  - 評価主体化
  - 旧思想の残存
  - 意味保証の内包
 という **3型に集約可能**

---

### 6.4.2 フェーズ6への接続点（確認）

この再分類により、フェーズ6では初めて次が可能になる。

- 型ごとに
  - pytest から外すもの
  - pytest に残す最小核
  を検討できる
- 個別テストを一つずつ議論する必要がなくなる

※ 本節は判断材料の整理のみであり、
  修正方針・設計変更案は含まない。

---

### 6.5 逸脱タイプ別に見た pytest に残る最小責務（事実整理）

本節では、6.4 で再分類した B 判定テスト群について、
各逸脱タイプごとに **pytest が実際に担っている責務の最小単位**を抽出する。

ここで行うのは以下のみである。

- pytest が「事実として何を確認しているか」を分解する
- その中から **評価・意味判断を除いた残余**を明示する
- それが pytest の最小責務になり得るかどうかは **判断しない**

---

#### 6.5.1 B-α（pytest が評価主体化している型）

**該当範囲**

- F4 Case1 / Case2 / Case3 writer 系テスト

**pytest が実際に行っている確認（分解）**

1. 質問送信が行われたこと
2. 応答が取得できたこと（None ではない）
3. 実行結果が所定のログ形式でファイルに書き出されたこと
4. ログ中に特定の語句が含まれること（※評価要素）

**評価要素を除いた残余（事実）**

- pytest は以下を確認している：
  - 実行パイプラインが **最後まで到達**した
  - F4 結果ログ（Markdown）が **生成された**
  - Execution Context 等のメタ情報が **欠損せずに存在**

→ **pytest が担っている最小の事実責務**

- 「F4 評価用の観測データが生成されたか」

---

#### 6.5.2 B-β（旧テスト思想を部分的に保持している型）

**該当範囲**

- test_rag_basic_v0_1.py
- test_rag_advanced_v0_1.py

**pytest が実際に行っている確認（分解）**

1. YAML で定義された質問ケースが読み込める
2. 各質問が送信できる
3. 応答テキストが取得できる
4. 応答中に expected_keywords が含まれる（※旧評価基準）

**評価要素を除いた残余（事実）**

- pytest は以下を確認している：
  - 質問ケース定義 → 実行 → 応答取得までが **破綻しない**
  - submit → probe の制御フローが **成立している**
  - 例外・タイムアウトなく **一連のケースを完走できる**

→ **pytest が担っている最小の事実責務**

- 「Basic / Advanced RAG 実行フローが成立しているか」

---

#### 6.5.3 B-γ（意味保証を暗黙に内包している型）

**該当範囲**

- F4 系 + Advanced RAG 系に重複

**pytest が実際に行っている確認（分解）**

1. 応答テキストが存在する
2. 応答に禁止語が含まれない（※意味評価）
3. 応答に重要語句が含まれる（※意味評価）

**評価要素を除いた残余（事実）**

- pytest は以下を確認している：
  - 応答が **空でない**
  - 応答が **取得不能状態ではない**
  - 実行結果が **記録可能な形式で存在**

→ **pytest が担っている最小の事実責務**

- 「応答データが評価可能な形で存在するか」

---

### 6.5.4 逸脱タイプ別・最小責務の整理（事実）

| 逸脱タイプ | pytest が実際に担っている最小責務（事実） |
| ----------- | ----------------------- |
| B-α | 評価用ログ（F4観測データ）が生成された |
| B-β | RAG 実行フローが破綻なく完走する |
| B-γ | 応答データが取得・保持されている |

※ これらが pytest に「残すべきかどうか」は本節では判断しない。

---

### 6.5.5 本節の位置づけ（確認）

- 本節は **設計修正・移動・削除を指示しない**
- あくまで、
  - pytest が「実際にやっていること」
  - その中で「評価を除いた残り」
を事実として切り出しただけである

この整理により、次フェーズでは初めて

- pytest に残す
- pytest から外す
- 別レイヤに移す
といった判断が **感覚ではなく責務単位**で可能になる。

---

### 6.6 pytest に残す責務／残さない責務の明示的線引き（設計判断）

本節では、6.5 で整理した「pytest が実際に担っている最小責務」を基に、
**pytest に残す責務**と **pytest から外す責務**を明示的に線引きする。

ここでの判断は以下の原則に基づく。

- pytest は **Contract Test の実行基盤**である
- pytest の PASS / FAIL は **CI 上で意味を持つ**
- 意味解釈・品質評価・比較判断は **CI に不向き**である

---

#### 6.6.1 pytest に残す責務（FIX）

以下の責務は pytest に残す。

これらは **設計上 pytest が担うべき最小責務**であり、
今後も PASS / FAIL 判定を伴う。

##### A. 実行パイプラインの成立確認

- 質問定義 → 送信 → 応答取得 → 終了までが破綻せずに完走すること
- submit / probe / resolver / loader 等の **責務分離が成立していること**
- 例外・タイムアウト・致命的欠損が発生しないこと

→ 対応レイヤ  

- Layer 1: Contract Tests  
- Layer 2: Behavior Tests（成立確認に限る）

---

##### B. 構造的保証（スキーマ・存在確認）

- 必須キー・必須フィールドが存在する
- オブジェクト構造・型・最低限の整合性が守られている
- 「評価可能な形でデータが存在する」ことの保証

→ 対応レイヤ  

- Layer 1: Contract Tests

---

##### C. 解決保証（決まる／決まらないの二値）

- 自動解決で確定する場合は **確定値が得られる**
- 未確定の場合は **ResolutionRequired 等の明示的状態になる**
- ユーザー入力が与えられれば **必ず最終確定できる**

→ 対応レイヤ  

- Layer 1: Contract Tests（F9-A 系）

---

#### 6.6.2 pytest に残さない責務（FIX）

以下の責務は pytest から外す。

これらは **CI における PASS / FAIL 判定と相性が悪く**、
設計上 pytest が担うべきではない。

##### D. 意味評価・品質評価

- 応答が「正しいか」「十分か」「自然か」
- 期待語句が *含まれている／いない* という評価
- Hallucination / Evidence / 網羅性などの意味的判断

→ 移動先  

- Layer 3: Evaluation Artifacts  
- 人手・別ツール・後処理対象

---

##### E. 比較評価・差分観測

- HTML vs Markdown の回答差分
- プロファイル間の挙動差
- モデル差・バージョン差の観測

→ 移動先  

- Layer 3: Evaluation Artifacts  
- pytest は「生成された」事実のみを保証

---

##### F. 人間の解釈を前提とする判断

- 「十分説明されている」
- 「附則まで含めている」
- 「全部列挙されているはず」

→ pytest では **扱わない**

---

#### 6.6.3 6.5 の逸脱タイプとの対応関係

| 逸脱タイプ | 6.5 で抽出した最小責務 | 6.6 の判断 |
| ----------- | ---------------------- | ----------- |
| B-α | F4 観測データが生成された | **生成確認のみ pytest に残す** |
| B-β | RAG 実行フローが完走 | **完走確認は pytest に残す** |
| B-γ | 応答データが存在 | **存在確認のみ pytest に残す** |

※ それ以外の評価要素はすべて pytest から外す。

---

#### 6.6.4 本線引きの意味（確認）

- これは「テストを弱くする」判断ではない
- pytest を **契約保証装置として純化**する判断である
- 意味評価を否定するのではなく、
  **置き場所を明確に分離した**だけである

この線引きにより、

- CI の安定性
- テストの責務一貫性
- 将来の評価拡張余地
が同時に確保される。

---

### 6.7 線引きの機械的適用結果（5.1–5.18）

本節では、6.6 で確定した線引きを、
フェーズ5でレビューした各テスト（5.1–5.18）に **機械的に適用**する。

- 個別最適・再解釈は行わない
- 判断根拠は 6.6 のみ
- 例外は設けない

---

#### 6.7.1 適用ルール（再掲・簡約）

- **pytest に残す**：  
  - 実行フロー成立  
  - 構造・存在保証  
  - 解決保証（確定／未確定の二値）

- **pytest から外す**：  
  - 意味評価  
  - 比較・差分評価  
  - 人手解釈前提の判定

---

#### 6.7.2 各テストへの適用結果一覧

| No. | セクション | テストファイル | 適用結果 | pytest に残る最小責務 |
| ----: | --------- | ------------- | --------- | ------------ |
| 1 | 5.1 | tests/test_smoke_llm.py | **残す（縮退）** | 実行完走・submit–probe成立 |
| 2 | 5.2 | tests/rag_entry/test_gate1_entry_minimal.py | **残す** | Entry実行成立・Context取得 |
| 3 | 5.3 | tests/rag_entry/test_gate1_schema_entry.py | **残す** | スキーマ・キー存在保証 |
| 4 | 5.4 | tests/f4/test_f4_case1_writer.py | **残す（縮退）** | F4ログ生成の事実確認 |
| 5 | 5.5 | tests/f4/test_f4_case2_writer.py | **残す（縮退）** | F4ログ生成の事実確認 |
| 6 | 5.6 | tests/f4/test_f4_case3_writer.py | **残す（縮退）** | F4ログ生成の事実確認 |
| 7 | 5.7 | tests/_legacy/rag/test_rag_basic_ask_v0_2.py | **外す（レガシー）** | ― |
| 8 | 5.8 | tests/diagnostic/test_profile_resolution.py | **残す** | プロファイル解決成立 |
| 9 | 5.9 | tests/rag/test_rag_basic_v0_1.py | **残す（縮退）** | Basic実行完走 |
| 10 | 5.10 | tests/rag/test_rag_advanced_v0_1.py | **残す（縮退）** | Advanced実行完走 |
| 11 | 5.11 | tests/f9/a/binding/test_ordinance_binder.py | **残す** | バインディング構造保証 |
| 12 | 5.12 | tests/f9/a/question/test_template_validator.py | **残す** | 抽象表現制約の二値判定 |
| 13 | 5.13 | tests/f9/a/question_set/test_csv_loader.py | **残す** | CSV→テンプレ変換保証 |
| 14 | 5.14 | tests/f9/a/resolution/test_auto_resolver.py | **残す** | 自動解決の二値保証 |
| 15 | 5.15 | tests/f9/a/resolution/test_user_input_resolver.py | **残す** | ユーザー入力解決保証 |
| 16 | 5.16 | tests/f9/a/test_a1_a2_integration.py | **残す** | A-1→A-2連結成立 |
| 17 | 5.17 | tests/f9/a/test_a2_a3_integration.py | **残す** | A-2→A-3連結成立 |
| 18 | 5.18 | tests/f9/a/test_a3_a4_integration.py | **残す** | A-3→A-4解決保証 |

---

#### 6.7.3 「縮退」とは何か（定義）

本節で用いる **縮退** とは以下を意味する。

- pytest の対象を  
  **意味評価・比較評価 → 生成・成立の事実確認** に縮小する
- assertion は  
  - 存在  
  - 型  
  - 非例外  
  のみに限定される
- 評価用ロジックは **削除または Layer 3 へ移動**

---

#### 6.7.4 本節の確定事項

- 5.1–5.18 の **全テストの処遇が確定**
- 追加判断は不要
- 次フェーズではこの表を **作業指示書としてそのまま使用**する

---

#### 6.7.5 次工程への引き渡し内容

- 削除対象：  
  - tests/_legacy/rag/test_rag_basic_ask_v0_2.py
- 縮退対象：  
  - F4 writer 系  
  - Basic / Advanced RAG v0.1 系
- 非縮退（維持）：  
  - Gate / F9-A / Diagnostic 系

以上をもって、フェーズ6は **判断と適用の両方が完了**した。

## 7. フェーズ4の完了条件（充足確認）

本章では、フェーズ4「設計と実装の差分確定」が
**完了条件を満たしているか**を事実ベースで確認し、
フェーズ4の完了を正式に宣言する。

---

### 7.1 完了条件①  
**全 test file の判断が A / B / C で確定していること**

#### 確認結果（事実）

- フェーズ5（5.1–5.18）において、
  - 対象とした全テストファイルについて
  - 判断（A / B / C）を明示的に付与した
- 6.7 において、
  - 6.6 の線引きを機械的に適用し
  - 各テストの最終処遇（残す／縮退／外す）を確定した

#### 補足整理

- A 判定：設計一致（No Action）
- B 判定：設計差分あり（縮退・役割変更を前提）
- C 判定：設計差分あり（非修正・設計上容認）

→ **未判定・保留状態の test file は存在しない**

---

### 7.2 完了条件②  
**「直さない判断」が設計根拠付きで残っていること**

#### 確認結果（事実）

以下について、「直さない」判断が **明示的な設計根拠付き**で残されている。

- B 判定テストのうち
  - pytest に残すが「縮退」するもの
  - pytest から外す（レガシー扱い）もの
- C 判定テスト（非修正）

これらについて、

- 6.5：pytest が実際に担っている最小責務（事実）
- 6.6：pytest に残す／残さない責務の線引き（設計判断）
- 6.7：線引きの機械的適用結果（個別適用）

という **三段階の設計根拠**が残っている。

#### 重要点

- 「直さない」は
  - 放置
  - 判断回避
 ではない
- **設計として意図的に残す／外す**ことが文書化されている

---

### 7.3 フェーズ4で「行っていないこと」（再確認）

以下はフェーズ4の対象外であり、意図的に行っていない。

- pytest / 実装コードの修正
- assertion の追加・削除
- CI 設定の変更
- テストの pass / fail 結果による判断変更

→ フェーズ4は **設計と判断の確定のみ**を目的とした。

---

### 7.4 フェーズ4 完了宣言

以上より、

- 判断対象となる test file はすべて網羅され
- 各テストの処遇は A / B / C で確定し
- 「直さない判断」を含め、すべて設計根拠付きで記録されている

よって、

**フェーズ4：設計と実装の差分確定 は完了した**。

---

### 7.5 次フェーズへの引き渡し事項（明示）

フェーズ5以降（実装修正フェーズ）への引き渡し内容は以下に限定される。

- 6.7 の適用結果表
- 削除対象テスト（レガシー）
- 縮退対象テストとその最小責務定義
- 非修正テスト（維持理由込み）

これ以外の再判断・再設計は行わない。

