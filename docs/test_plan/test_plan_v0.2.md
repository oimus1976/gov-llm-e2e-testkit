---
title: Test Plan v0.2.0
project: gov-llm-e2e-testkit
document_type: test_design_master
status: active
version: v0.2.0
updated: 2026-01-10
---

## 0. メタ情報

### 0.1 文書の位置づけ

本ドキュメント **test_plan_v0.2.0** は、  
`gov-llm-e2e-testkit` リポジトリにおける **テスト設計計画の正本（設計正本）**である。

本ドキュメントは以下を目的とする。

- 本リポジトリが担うテスト責務の全体像を定義する
- 各テストの役割・保証範囲・非保証範囲を明確にする
- pytest の pass / fail が工程上どのような意味を持つかを規定する
- テストの追加・変更・削除を場当たり的に行わないための判断基準を提供する

### 0.2 本ドキュメントが「正本」とする範囲

本ドキュメントは **設計正本**であり、以下を規定対象とする。

- テスト全体のレイヤー構成
- 各レイヤーの責務と境界
- CI において保証すべき内容と、保証しない内容
- pytest を用いた自動テストの運用方針

一方で、本ドキュメントは **実行手順の正本ではない**。

### 0.3 他文書との関係（正本の分離）

本リポジトリにおける文書の役割分担は、以下のとおり明確に分離される。

- **test_plan（本ドキュメント）**  
  テスト設計・思想・責務を定義する「設計正本」

- **docs/operation 配下の文書**  
  実際のテスト実行手順・運用手順を定義する「実行正本」

- **README**  
  プロジェクト概要および入口案内（詳細仕様は含まない）

README や実行手順書に記載された内容が、本ドキュメントと矛盾する場合、  
**設計上の判断基準としては本ドキュメントを優先**する。

### 0.4 適用範囲

本ドキュメントは、以下を適用範囲とする。

- 本リポジトリに含まれるすべての pytest ベースのテスト
- E2E / UI / RAG 関連の自動テスト
- 観測・評価・分析目的で生成される成果物の位置づけ整理

ただし、以下は明示的に対象外とする。

- LLM の意味的正しさ・回答品質の保証
- 業務的な正解・誤答の判定
- モデル選定や性能比較そのもの

### 0.5 本ドキュメントの更新ルール

- テストレイヤー構成や責務に変更が生じる場合、  
  **実装や pytest 修正より先に本ドキュメントを更新する**
- CI 対象テストの変更は CHANGELOG に記録する
- 工程・成果物の扱いに関わる変更は PROJECT_STATUS に反映する

本ドキュメントは、  
「現状を説明するための記録」ではなく、  
**今後の実装判断を拘束するための設計文書**として扱う。

---

## 1. 本テスト計画の目的と前提

本章では、本テスト計画が何を目的として策定されているのか、  
また、本リポジトリにおけるテスト設計の前提条件を明示する。

本テスト計画は、個別テストの是非を判断するための補助資料ではなく、  
**テスト全体の意味づけと責務境界を規定するための設計文書**である。

---

### 1.1 本計画の目的

本計画の第一の目的は、  
`gov-llm-e2e-testkit` において **「テストとは何か／何ではないか」**を明確に定義することである。

本リポジトリでは、これまで以下のような混同が発生しやすい状態にあった。

- 工程前提を保証するためのテスト
- RAG の挙動や傾向を観測するためのテスト
- 評価・分析・比較のために生成される成果物

これらが pytest 上で同列に扱われることで、  
pass / fail の意味が曖昧になり、場当たり的な修正判断を招いていた。

本計画は、この状況を是正するために、

- pytest の pass / fail が  
  **工程上どのような意味を持つのか**を明確にし
- テストの追加・修正・削除を  
  **個別事象への対応ではなく、計画に基づいて行える状態**を作る

ことを目的とする。

すなわち、本計画は  
「テストを通すためのルール」ではなく、  
**「どのテストが、何を保証するのかを判断するための基準」**を提供するものである。

---

### 1.2 前提条件

本テスト計画は、以下の前提条件に基づいて策定されている。

#### 1.2.1 本プロジェクトの責務範囲

本プロジェクトは、LLM を用いたシステムに対して、

- 工程が再現可能であること
- 実行結果が観測可能であること

を保証対象とする。

一方で、以下は**明示的に本プロジェクトの責務外**とする。

- LLM の意味的正しさ
- 回答内容の品質評価
- 業務的な正解・誤答の判定
- モデル性能そのものの優劣比較

これらは、別途評価・分析・意思決定の文脈で扱われるべきものであり、  
pytest の pass / fail によって保証されるものではない。

#### 1.2.2 テスト設計上の基本原則

本計画では、以下の原則を前提とする。

- **保証を目的とするテスト**と  
  **観測を目的とするテスト**を混在させない
- pass / fail を持つテストは、  
  工程前提の成立可否のみを判定対象とする
- 観測・評価・分析目的の成果物は、  
  pytest の成否判定から切り離して扱う

これにより、

- pytest が失敗した場合に  
  「工程前提が破綻している」と判断でき
- pytest が成功した場合に  
  「少なくとも工程は再現可能である」と言える

状態を維持することを、本計画の前提とする。

---

## 2. テスト設計の基本思想（Design Principles）

本章では、本テスト計画全体を貫く設計思想を明示する。  
ここで定義する思想は、個別テストの実装詳細よりも上位に位置づけられ、  
以降の章で示されるテスト構成・運用方針の判断基準となる。

---

### 2.1 テストの責務分離

本テスト計画では、「テスト」という言葉の下に異なる目的の活動が混在することを避けるため、  
テストおよび関連成果物を以下の三つに明確に分類する。

#### 2.1.1 保証テスト

保証テストは、**工程前提が満たされていることを保証する**ためのテストである。

ここでいう工程前提とは、以下のような事実を指す。

- 想定された操作手順が実行可能であること
- UI 操作や API 呼び出しが中断なく完了すること
- 実行結果が観測可能な形で得られること

保証テストは pytest によって自動実行され、  
pass / fail によって **工程前提が成立しているかどうか**を明確に示す。

このため、保証テストにおける failure は、  
「工程の再現性が失われている」ことを意味する。

#### 2.1.2 観測テスト

観測テストは、**判断材料を収集すること**を目的としたテストであり、  
工程前提の成立可否を判定するものではない。

観測テストでは、以下のような情報を取得することが想定される。

- RAG の挙動や傾向
- 回答に含まれるキーワードや形式の変化
- 想定外の挙動や兆候の発生有無

これらは設計・運用・評価の判断材料として有用であるが、  
pytest の pass / fail によって良否を断定すべきものではない。

そのため、観測テストは pytest 上で実行される場合であっても、  
その成否がプロジェクト全体の成否を直接的に意味することはない。

#### 2.1.3 評価成果物

評価成果物は、**分析・比較・意思決定のために生成されるデータ**であり、  
本計画においては「テスト」とは区別して扱う。

評価成果物の例としては、以下が挙げられる。

- 複数実行結果の比較データ
- raw_evidence の集計結果
- 統計情報や傾向分析結果

これらは、設計判断や改善検討において重要な情報を提供するが、  
pytest の pass / fail によって評価される対象ではない。

本計画では、評価成果物を  
**テスト工程の外縁に位置づける**ことで、  
テストの責務を過度に肥大化させないことを重視する。

---

### 2.2 pytest の役割

本リポジトリにおける pytest の役割は、  
単なるテスト実行ツールではなく、**工程前提を自動的に検証する手段**である。

pytest に求められる役割は、以下のとおりである。

#### 2.2.1 自動実行可能であること

pytest で実行されるテストは、  
人手による判断や介入を前提とせず、自動的に実行可能でなければならない。

これにより、環境差異や担当者差異による判断の揺れを排除する。

#### 2.2.2 冪等であること

pytest によるテスト実行は、  
同一条件下であれば繰り返し実行しても同じ結果を返すことが求められる。

一時的な状態や外部要因に強く依存するテストは、  
工程前提の検証として不適切である。

#### 2.2.3 pass / fail の意味が明確であること

pytest の pass / fail は、  
**工程前提が成立しているか否か**のみを示すものでなければならない。

- pass：工程前提は満たされている
- fail：工程前提が破綻している、または前提条件が満たされていない

この意味づけが崩れると、  
pytest の結果は設計判断に利用できなくなる。

---

### 2.3 「テストを甘くしない」ための原則

本計画では、「テストを甘くする」ことを  
単に assertion を削減する行為とは捉えない。

本計画において問題とするのは、  
**テストの責務を曖昧にしたまま通過条件を調整すること**である。

#### 2.3.1 assertion 削除時の原則

assertion を削除または緩和する場合、  
必ず以下を同時に検討・更新する。

- 当該テストが属するレイヤーの再確認
- そのテストが保証すべき工程前提の見直し

単にテストを通すためだけの assertion 調整は、  
設計の後退とみなす。

#### 2.3.2 テストを目的化しない

テストは、あくまで  
**工程が再現可能であることを確認するための手段**である。

pytest を通過させること自体を目的化した時点で、  
テストは設計判断の拠り所としての価値を失う。

本計画では、  
テストの存在理由を常に本章の原則に立ち返って確認することを求める。

---

## 3. テスト全体構成（レイヤーモデル）

本章では、本テスト計画におけるテスト全体の構成を  
**レイヤーモデル**として明示する。

このレイヤーモデルは、個々のテストケースの分類基準であると同時に、  
pytest・CI・評価成果物の扱いを判断するための上位構造である。

---

### 3.1 レイヤー一覧（概要）

本リポジトリにおけるテストおよび関連成果物は、  
以下の三つのレイヤーに分類される。

| レイヤー | 名称 | 位置づけ | CI 対象 |
| --- | --- | --- | --- |
| Layer 1 | Contract Tests | 工程前提の保証 | Yes |
| Layer 2 | Behavior Tests | RAG 挙動の観測 | No |
| Layer 3 | Evaluation Artifacts | 評価・分析用成果物 | No |

各レイヤーは、**役割・責務・運用方針が明確に異なる**ものであり、  
同一の基準で pass / fail を扱うことはしない。

---

### 3.2 各レイヤーの基本的な位置づけ

#### 3.2.1 Layer 1：Contract Tests

Layer 1 は、本リポジトリが **工程前提を保証するためのテスト層**である。

- pytest による自動実行を前提とする
- CI において常時実行される
- pass / fail は工程前提の成立可否を意味する

Layer 1 に属するテストが fail した場合、  
それは「実装が壊れている」ことではなく、  
**想定された工程前提が満たされていない**ことを示す。

#### 3.2.2 Layer 2：Behavior Tests

Layer 2 は、RAG の挙動や傾向を **観測するためのテスト層**である。

- pytest 上で実行される場合がある
- CI 対象とはしない
- pass / fail はプロジェクトの成否を直接示さない

Layer 2 のテスト結果は、  
設計判断や運用判断のための **判断材料**として利用される。

#### 3.2.3 Layer 3：Evaluation Artifacts

Layer 3 は、評価・分析・比較のために生成される **成果物の集合**である。

- pytest の対象外とする
- pass / fail の概念を持たない
- 分析・意思決定のためのデータとして扱う

Layer 3 に含まれる成果物は、  
テスト工程の結果として生成される場合はあっても、  
**テストそのものではない**。

---

### 3.3 レイヤー間の関係

本テスト計画におけるレイヤー間の関係は、  
以下の原則に基づいて定義される。

#### 3.3.1 前提関係の非依存性

- 上位レイヤーは、下位レイヤーの成立を前提としない
- Layer 1 の成否は、Layer 2 や Layer 3 の結果に依存しない
- Layer 2 や Layer 3 の結果が不十分であっても、  
  Layer 1 の保証が成立していれば工程前提は満たされていると判断する

これにより、評価や分析の未完了が  
工程全体の停止理由になることを防ぐ。

#### 3.3.2 Layer 3 の扱い

Layer 3（Evaluation Artifacts）は、  
**テスト計画の外縁**として明確に位置づける。

Layer 3 は、

- テストの成否を左右しない
- CI の可否判定に影響しない
- 生成されなくても failure とはならない

という特性を持つ。

この位置づけにより、  
評価・分析活動がテスト計画を侵食することを防ぎ、  
テストの責務を過度に肥大化させない。

---

本レイヤーモデルは、  
以降の章において各レイヤーを個別に詳細化する際の  
**共通の前提構造**として用いられる。

---

## 4. Layer 1：E2E Contract Tests（必須）

本章では、Layer 1 に位置づけられる  
**E2E Contract Tests** の役割・保証範囲・非保証範囲を明確に定義する。

Layer 1 は、本リポジトリにおいて  
**唯一「保証」を目的とするテスト層**であり、  
pytest および CI によって常時実行されることを前提とする。

---

### 4.1 位置づけ

Layer 1（E2E Contract Tests）は、  
本リポジトリが担う責務の中で、以下の性質を持つ。

- 本リポジトリが **唯一「保証する」テスト層**である
- CI において常時実行される
- failure は **工程前提違反**を意味する

ここでいう工程前提とは、  
「想定された一連の操作・遷移・観測が、再現可能な形で成立すること」を指す。

Layer 1 のテストが fail した場合、  
それは LLM の品質や挙動の問題ではなく、  
**E2E 工程そのものが成立していない**ことを示す。

---

### 4.2 保証対象（Guarantees）

Layer 1 において保証する対象は、  
**工程が最後まで成立するかどうか**に限定される。

具体的には、以下を保証対象とする。

- ログイン工程が成立すること
- チャット画面への遷移が成立すること
- 質問投入操作が完了すること
- submit 完了セマンティクスが成立すること  
  （例：submit ボタンの gray → blue 遷移）
- 回答生成イベントが **観測可能であること**

ここで重要なのは、  
「回答が生成されたかどうか」を  
**内容ではなく、イベントとして観測可能か**で判断する点である。

Layer 1 では、  
「生成された回答が何であるか」は一切評価しない。

---

### 4.3 非保証対象（Non-goals）

Layer 1 は、工程前提の保証に特化するため、  
以下の事項は **明示的に非保証対象**とする。

- 回答内容の正しさ・妥当性
- 回答文の有無・長さ・表現
- raw_evidence の内容・件数・品質
- RAG の検索精度や関連性

これらは、Layer 2（Behavior Tests）や  
Layer 3（Evaluation Artifacts）において扱う対象であり、  
Layer 1 の pass / fail 判定には一切影響しない。

---

### 4.4 対象テスト例

Layer 1 に属する代表的なテスト例として、  
以下が挙げられる。

- **Smoke Test**  
  最低限の工程が成立することを確認するテスト

- **Gate1 Entry Minimal**  
  submit 完了セマンティクスを最小条件で検証するテスト

- **Submit / Probe Existence Check**  
  回答生成に関連するイベントが観測可能であることを確認するテスト

これらのテストは、  
すべて「工程前提の保証」という共通目的に基づいて設計される。

---

### 4.5 F4 / Gate / Smoke 再配置指針（設計ルール）

本節では、
本リポジトリにおいて長らく混在してきた
**F4 / Gate / Smoke 系テスト・成果物の位置づけ**を、
test_plan_v0.2.0 のレイヤーモデルに基づいて再整理する。

本指針は、
既存テストの移動・削除・再分類を行う際の
**設計上の判断基準**を提供することを目的とする。

---

#### 4.5.1 再配置の前提原則

再配置にあたっては、以下の原則を必ず満たすものとする。

- テストの配置は
  **「何を保証するか」ではなく「何を保証しないか」**で判断する
- pytest に含めるか否かは
  **工程前提を保証する責務があるかどうか**で決める
- 「今までそうだった」は判断理由にならない

---

#### 4.5.2 Smoke Test の位置づけ

Smoke Test は、
**工程が最低限成立するかどうか**を確認するためのテストである。

したがって Smoke Test は、

- Layer 1（Contract Tests）に属する
- CI で常時実行される
- 内容・品質・意味評価を一切含まない

Smoke Test に含めてよいのは、以下のみである。

- ログインが可能である
- 画面遷移が成立する
- submit 操作が完了する
- 回答生成イベントが観測可能である

Smoke Test に、
raw_evidence の中身や回答文の有無を含めてはならない。

---

#### 4.5.3 Gate 系テストの位置づけ

Gate 系テスト（例：Gate1 Entry Minimal）は、
工程の途中段階が **明示的に成立したかどうか**を確認するための
Contract Tests である。

Gate 系テストは、

- Layer 1（Contract Tests）に属する
- 工程の「通過条件」を確認する
- 通過後の挙動や品質は扱わない

Gate 系テストにおいて確認できるのは、

- 入力操作が完了したか
- submit 完了セマンティクスが成立したか
- 次工程へ進むための状態が観測可能か

までであり、
**その後に何が生成されたか**は対象外とする。

---

#### 4.5.4 F4 trial dataset の位置づけ

F4 trial dataset は、
Gate や Smoke の延長線上にあるテスト成果物ではない。

F4 trial dataset は、

- Layer 3（Evaluation Artifacts）に属する
- pytest の対象外である
- 工程前提の保証責務を一切持たない

F4 trial dataset は、

- 分析
- 比較
- 評価
- 設計判断

のための材料としてのみ利用される。

その生成有無・内容・形式は、
Contract Tests の成否に影響してはならない。

---

#### 4.5.5 再配置判断のチェックリスト

既存テスト・成果物を再配置する際は、
以下の問いに必ず答える。

- これは工程前提を保証しているか？

  - Yes → Layer 1
  - No → 次へ
- これは挙動を観測しているか？

  - Yes → Layer 2
  - No → 次へ
- これは分析・評価のための成果物か？

  - Yes → Layer 3

この問いに明確に答えられないものは、
**テストとして存在すべきではない**。

---

#### 4.5.6 本指針の効力

本指針は、

- 既存テストの再分類
- 新規テストの設計
- assertion の追加・削除判断

において、
test_plan_v0.2.0 の他章と同等の
**設計拘束力を持つ**ものとして扱う。

---

本章で定義した内容は、  
Layer 1 に属するすべてのテスト実装に対する  
**設計上の拘束条件**として扱う。

---

## 5. Layer 2：RAG Behavior Tests（観測系）

本章では、Layer 2 に位置づけられる  
**RAG Behavior Tests** の目的・位置づけ・運用方針を定義する。

Layer 2 は、pytest を用いて実行される場合があっても、  
**品質保証を目的とするテスト層ではない**。

ここで得られる結果は、  
設計判断・運用判断・比較分析のための **観測データ**として扱う。

---

### 5.1 位置づけ

Layer 2（RAG Behavior Tests）は、  
以下の特徴を持つ観測系テスト層である。

- 品質保証を目的としない
- pass / fail によって工程の正否を判断しない
- RAG システムの挙動傾向を把握するための材料を提供する

Layer 2 における「テスト」は、  
**保証のための判定装置ではなく、観測のための実行器**である。

したがって、Layer 2 の結果は  
「良い／悪い」を即断するものではなく、  
**設計・運用の意思決定を支援する情報**として扱う。

---

### 5.2 観測内容の例

Layer 2 では、以下のような挙動を観測対象とする。

- 想定質問に対するキーワード出現傾向
- 明らかな hallucination の兆候
- 回答形式や構造の安定性の傾向
- プロンプト変更やデータ差し替え時の応答変化

これらはすべて、  
**相対比較や時系列比較を前提とした観測項目**であり、  
単発実行の pass / fail で評価されるものではない。

---

### 5.3 実行・評価方針

Layer 2 の実行および評価に関して、  
以下を原則とする。

- CI では原則実行しない
- pytest failure はプロジェクト failure を意味しない
- 結果は比較・分析用データとして保存する

Layer 2 の pytest failure は、  
「異常」ではなく **観測結果の一種**として扱う。

したがって、CI に組み込む場合は、  
必ず Layer 1 とは分離された実行経路を持たせる。

---

### 5.4 対象テスト

Layer 2 に属するテストの代表例は以下のとおりである。

- **Basic RAG Tests**  
  基本的な質問セットに対する挙動観測

- **Advanced RAG Tests**  
  条件・難易度・文脈を変えた応答挙動の観測

これらのテストは、  
Layer 1 の Contract Tests が成立していることを前提に実行されるが、  
Layer 1 の pass / fail 判定には影響を与えない。

---

Layer 2 は、  
「テストを通すための仕組み」ではなく、  
**考えるための材料を蓄積する仕組み**として設計・運用される。

---

## 6. Layer 3：Evaluation Artifacts（非テスト成果物）

本章では、Layer 3 に位置づけられる  
**Evaluation Artifacts** の扱いを明確に定義する。

ここで扱う成果物は、  
pytest を用いて生成・検証されることがあっても、  
**テストではない**。

---

### 6.1 位置づけ（重要）

Layer 3 に属するものは、以下を原則とする。

- **これはテストではない**
- pytest の pass / fail 判定対象外
- 品質保証や工程前提の検証を目的としない
- 評価・分析・意思決定のための材料である

Layer 3 は、  
「保証」でも「観測」でもなく、  
**思考と判断を支援するための成果物層**である。

そのため、Layer 3 の欠損や未生成は、  
プロジェクトの failure を意味しない。

---

### 6.2 含まれるもの

Layer 3 に含まれる代表的な成果物は以下のとおりである。

- **F4 trial dataset**
- raw_evidence の集計結果
- execution_context の記録
- derived_summary（統計・傾向・比較用データ）

これらは、  
テスト実行結果の「副産物」や  
特定工程のアウトプットとして生成されうるが、  
**テストの成否を判断するための入力ではない**。

---

### 6.3 生成タイミングと責任範囲

Layer 3 の成果物は、  
以下の条件下で生成されることを想定する。

- 主に **F10-A 等の成果物生成工程**に付随して生成されうる
- CI 実行時には原則生成しない
- ローカル実行・検証・分析フェーズで生成される

Layer 3 の成果物は、  
生成されなくても failure とはならず、  
生成の有無や内容について pytest が判断することはない。

---

### 6.4 方針変更の明示

本計画において、以下の方針変更を明示する。

- **F4 trial dataset は評価・分析用成果物として再分類する**
- F4 trial dataset に対する schema assertion は行わない
- F4 trial dataset を pytest の対象から完全に切り離す

これにより、

- 「データがある／ない」
- 「中身が揃っている／揃っていない」

といった状態差が、  
テスト failure と誤認されることを防ぐ。

---

## 6.5 F4 trial dataset の正式な引退宣言（改訂版）

本テスト計画 v0.2.0 において、
**F4 trial dataset は pytest によるテスト対象としての役割を正式に終える**。

### 6.5.1 背景

F4 trial dataset は当初、

- RAG 実行結果を一定形式で蓄積する
- 後続の分析・比較・検討に用いる

ことを目的とした **試行的な評価用データセット**として導入された。

しかし実運用においては、

- pytest による schema assertion の対象となった
- pass / fail 判定に組み込まれた
- CI 上の failure 要因として扱われた

結果、F4 trial dataset は本来意図していなかった
**「工程前提の保証責務」を負う状態**となった。

これは、

- テスト計画上の責務定義
- pytest の役割
- 評価成果物の位置づけ

が十分に分離されていなかったことに起因する。

---

### 6.5.2 問題点の整理

F4 trial dataset を pytest の検証対象としたことで、以下の問題が顕在化した。

- 評価用データの欠損・未生成が **工程 failure と誤認される**
- データ構造の変化が **設計変更ではなくテスト破壊として扱われる**
- 分析・比較のための試行錯誤が抑制される
- Gate 系テストや Contract Tests の責務境界が不明瞭になる

これらは、
**テストを通すために評価成果物を歪める**という逆転現象を引き起こし、
本プロジェクトの設計思想と明確に矛盾する。

---

### 6.5.3 本計画における決定

以上を踏まえ、本テスト計画では以下を正式に決定する。

- **F4 trial dataset は Evaluation Artifacts（Layer 3）にのみ属する**
- F4 trial dataset に対する pytest による assertion は一切行わない
- F4 trial dataset の生成有無・内容は、テストの成否に影響しない
- CI において F4 trial dataset は生成・検証されない

なお、本決定は
**F4 trial dataset の削除や生成停止を意味するものではない**。

F4 trial dataset は今後も、

- 評価
- 分析
- 比較
- 設計判断

のための材料として利用されうるが、
それらはすべて **pytest の外側**で扱われる。

工程前提の保証は Layer 1（Contract Tests）でのみ行い、
Layer 3 はそれを前提とした後段の成果物層として位置づける。

---

### 6.5.4 pytest / CI に関する明示的禁止事項

以下の行為は、本テスト計画において明確に禁止する。

- F4 trial dataset に対する pytest assertion の追加
- F4 trial dataset の schema を pass / fail 判定条件に含めること
- CI において F4 trial dataset の生成・検証を必須化すること

これにより、

- 「データがある／ない」
- 「中身が揃っている／揃っていない」

といった状態差が、
テスト failure と誤認されることを防ぐ。

---

### 6.5.5 再導入に関する注意

将来、F4 trial dataset または同等の成果物を
pytest の検証対象として再導入する場合は、

- 本テスト計画における **Layer 定義の見直し**
- pytest の **保証対象の再定義**
- CI における failure 意味の再設計

を **先に文書として更新すること**を必須とする。

コード変更や assertion 追加を先行させることは認めない。

---

### 6.5.6 結語

F4 trial dataset の引退は、
機能削除ではなく **設計の成熟による整理**である。

本プロジェクトにおいて、

- テストは工程前提を保証するために存在し
- 評価成果物は判断を支援するために存在する

という原則を守るため、
F4 trial dataset は pytest から完全に切り離される。

---

### 6.6 Evaluation Artifacts の保存・利用方針

Evaluation Artifacts（Layer 3 に属する成果物）は、  
比較・分析・意思決定を行うための材料として保存・利用される。

これらの成果物は、  
特定工程のアウトプットや検証作業の副産物として生成されうるが、  
テストの成否を判断するための入力や前提条件として扱われない。

Evaluation Artifacts は、  
人間による設計判断・運用判断を支援する目的でのみ参照され、  
pytest や CI の自動判定ロジックに組み込まれることはない。

また、Evaluation Artifacts が生成されない場合や、  
一部が欠損している場合であっても、  
それ自体がプロジェクトの failure を意味することはない。

本計画において、Evaluation Artifacts は  
「正しさを証明するための成果物」ではなく、  
**考え、判断するための成果物**としてのみ位置づけられる。

---

Layer 3 は、  
「正しさを証明するための層」ではなく、  
**考えるための層**としてのみ扱われる。

---

## 7. pytest 運用ポリシー

本章では、本リポジトリにおける pytest の運用ルールを明示する。  
ここで定義するのは「pytest をどう使うか」ではなく、  
**pytest を何のために使い、何をさせないか**である。

---

### 7.1 マーカー設計

pytest のテストは、以下のマーカーによって明確に区分する。

#### `@pytest.mark.contract`

- Layer 1：E2E Contract Tests に該当
- 工程前提を**保証する**テスト
- CI で常時実行される
- failure は工程前提違反を意味する

例：

- Smoke Test
- Gate1 Entry Minimal
- Submit / Probe Existence Check

---

#### `@pytest.mark.behavior`

- Layer 2：RAG Behavior Tests に該当
- 挙動を**観測する**ためのテスト
- 品質保証を目的としない
- failure はプロジェクト failure を意味しない

例：

- Basic RAG Tests
- Advanced RAG Tests

---

#### evaluation 成果物について

- Layer 3：Evaluation Artifacts は pytest の対象外とする
- マーカーは付与しない
- pytest による pass / fail 判定を行わない

---

### 7.2 実行方法

#### CI / 通常開発時（保証テストのみ）

CI および通常の開発環境では、  
**contract テストのみ**を実行する。

```bash
pytest -m contract
```

これにより、

- 工程前提の破壊を即座に検知できる
- 観測系・評価系の揺らぎが CI を汚染しない

状態を維持する。

---

#### 手動観測・検証時（挙動観測）

RAG の挙動確認や設計判断のために、
behavior テストを明示的に実行する。

```bash
pytest -m behavior
```

この実行結果は、

- pass / fail に一喜一憂するものではなく
- 比較・分析・判断の材料として扱う

---

### 7.3 禁止事項（重要）

以下を**明確に禁止**する。

- contract テストに観測・評価ロジックを混入させること
- behavior テストの failure をもって品質問題と断定すること
- evaluation 成果物を pytest で検証しようとすること

これらはすべて、
「テストを通すことが目的化する」状態を引き起こす。

---

pytest は万能の評価装置ではない。
本プロジェクトにおいて pytest は、
**工程前提を守るための自動番人**
としてのみ使われる。

---

## 8. CI との関係

本章では、CI（継続的インテグレーション）が  
**何を保証し、何を保証しないのか**を明確に定義する。

CI の役割を過不足なく限定することで、

- 過剰な期待
- 誤った failure 解釈
- 「CI が赤い＝品質が悪い」という短絡

を防止する。

---

### 8.1 CI が保証するもの

CI が保証するのは、以下の一点のみである。

- **Layer 1：E2E Contract Tests がすべて pass すること**

これはすなわち、

- ログイン工程が成立している
- チャット画面への遷移が成立している
- 質問投入操作が完了する
- submit 完了セマンティクスが成立する
- 回答生成イベントが観測可能である

という **工程前提が破壊されていない**ことを意味する。

CI の green は、

> 「このリポジトリが保証責務を果たしている」

という最小限かつ十分な状態を示す。

---

### 8.2 CI が保証しないもの

CI は、以下を**一切保証しない**。

- RAG の意味的正しさ
- 回答の品質・網羅性・妥当性
- hallucination の有無
- 評価指標（スコア・ランキング等）
- 比較・分析結果
- 過去実行結果との傾向差分

これらはすべて、

- Layer 2（観測）
- Layer 3（評価成果物）

の領域に属し、  
CI の pass / fail によって判断されるべきものではない。

---

### 8.3 CI failure の解釈指針（重要）

CI が failure した場合、その意味は常に一つである。

> **工程前提が破壊された**

以下の解釈は禁止する。

- 「モデルの回答が悪くなった」
- 「RAG の品質が下がった」
- 「質問セットが悪い」

CI failure は、
**テスト計画違反または実装の工程逸脱**として扱う。

---

CI は裁判官ではない。  
品質を裁かず、意味を評価せず、  
ただ淡々と「前提が守られているか」を監視する。

それ以上の役割を期待した瞬間、  
テストは壊れ始める。

---

## 9. 変更管理と他文書との関係

本章では、本テスト計画とリポジトリ内の他文書との関係、および  
テストに関する変更をどのように管理するかを定義する。

テストの混乱は、多くの場合  
**コードではなく文書の役割不明確さ**から発生する。

---

### 9.1 文書の役割分担

本リポジトリにおける文書の役割分担は、以下のとおりとする。

#### test_plan（本書）

- **テスト設計の正本**
- テストの思想・レイヤー構成・保証範囲を規定する
- 「なぜこのテストが存在するか」を説明する文書
- pytest の pass / fail の意味を定義する

---

#### docs/operation 配下文書

- **実行手順の正本**
- 実務上の操作方法・注意事項・禁止事項を記載する
- 「どう実行するか」を定義する文書
- test_plan の内容を前提として記述される

---

#### README

- 概要・導線・入口としての役割
- 初見の読者に全体像を伝える
- 詳細手順や判断基準は記載しない
- 正本へのリンクを示すに留める

---

### 9.2 変更時のルール

テストに関する変更は、必ず以下の順序とルールで行う。

---

#### テストレイヤー・責務の変更

- Layer 構成・保証範囲・Non-goals を変更する場合
- **必ず test_plan を先に更新する**
- 実装変更や assertion 調整を先行させてはならない

---

#### CI 対象の変更

- CI で実行されるテストの追加・削除・性質変更を行った場合
- **CHANGELOG に明記する**
- CI failure の意味が変わる変更は特に明示する

---

#### 工程・進捗に関わる変更

- Gate 定義変更
- F 番号単位の進捗更新
- 成果物位置づけの変更

これらはすべて、

- **PROJECT_STATUS に反映する**

---

### 9.3 禁止事項（再掲）

以下を禁止する。

- 文書を更新せずにテストの意味を変えること
- README だけを直して正本を放置すること
- pytest の assertion 調整を「とりあえず」で行うこと

テストはコードではなく**契約**である。  
契約を変えるなら、まず契約書を直す。

---

本テスト計画は、  
一度書いて終わりの文書ではない。

しかし、  
**理由なく揺らがせてよい文書でもない。**

---

## 10. 付録

本章は、本テスト計画を正しく読み解き、運用するための補助情報をまとめた付録である。  
本文の規定を上書きするものではなく、**解釈の揺れを防ぐための参照点**として位置づける。

---

### A. 用語定義

本リポジトリで用いられる主要用語を、  
一般的な意味ではなく **本テスト計画における定義**として明示する。

---

#### Contract（Contract Tests）

- 工程前提を**保証する**ためのテスト
- pass / fail が明確な意味を持つ
- failure は工程逸脱・前提破壊を意味する
- CI の必須実行対象

例：

- ログインできない
- submit 完了セマンティクスが成立しない
- 回答生成イベントが観測できない

---

#### Behavior（Behavior Tests）

- RAG の挙動を**観測する**ためのテスト
- 品質保証を目的としない
- pass / fail は参考情報に過ぎない
- CI の対象外

例：

- 回答文の傾向
- キーワード出現頻度
- 形式の揺らぎ

---

#### Evaluation（Evaluation Artifacts）

- 評価・分析・意思決定のための**成果物**
- テストではない
- pytest の対象外
- pass / fail の概念を持たない

例：

- F4 trial dataset
- raw_evidence 集計結果
- derived_summary

---

#### Gate1

- 質問投入から submit 完了までの最小工程チェック
- **回答内容・品質は一切含まない**
- Contract Tests に属する

---

#### submit semantics（submit 完了セマンティクス）

- submit 操作が完了したことを示す UI / 状態遷移
- 例：
  - submit ボタンの gray → blue 遷移
- 回答生成そのものとは別概念

---

#### probe

- 回答生成イベントや通信を**観測する仕組み**
- 成功・失敗を断定するものではない
- 観測事実のみを提供する

---

### B. 既存テストの再分類表

本節では、既存テストを test_plan_v0.2.0 のレイヤーモデルに再分類する。
本表は、**既存テストの移動・削除・再配置判断の正本**として扱われる。

| 旧テスト名 / 機能 | 新レイヤー | 備考 |
| ----------------------------------- | ----------- | ------ |
| Smoke Test | Layer 1（Contract） | CI 必須。工程前提のみを保証 |
| Gate1 Entry Minimal | Layer 1（Contract） | submit 完了セマンティクス確認 |
| Submit / Probe Existence Check | Layer 1（Contract） | 生成イベントの存在のみ観測 |
| Basic RAG Tests | Layer 2（Behavior） | 観測系。CI 非対象 |
| Advanced RAG Tests | Layer 2（Behavior） | 観測系。CI 非対象 |
| F4 trial dataset schema tests | Layer 3（Evaluation） | pytest 対象外。成果物のみ |
| raw_evidence schema assertion | Layer 3（Evaluation） | pytest から完全除外 |

※ Layer 3 に分類されたものは、  
pytest から切り離され、**評価・分析用途としてのみ保持される**。  
これらの有無・構造は、テスト failure の条件とならない。

---

### 付録C：既存テスト棚卸し・再配置対応表（実装対応正本）

本付録は、
付録B「既存テストの再分類表」において確定された**設計上の再分類判断**に基づき、
`tests/` 配下に存在するすべての pytest テストファイルを対象として、

- 継続すべきテスト
- 廃止すべきテスト
- 再配置（移動）すべきテスト

を **実ファイル単位で対応付けた実装対応表**である。

本表は、

- 「どのテストがどのレイヤーに属するか」という**設計判断**を付録Bに委ね、
- 「その判断を、どの実ファイルにどう適用するか」という**実装判断**を確定する

ことを目的とする。

---

#### 本付録における重要な定義

- 本表は **既存テストの扱い（✔ / ✖ / →）を決定する唯一の実装正本**である
- ただし、**再配置先レイヤーの意味論的定義は付録Bを正本とする**
- 本表における「→ 移動」とは、
  **付録Bで定義された該当テスト分類（Layer）への再配置**を意味する

再配置に伴う以下の事項は、本表単体では定義しない。

- pytest マーカーの付与方法
- ディレクトリ構成の変更有無
- CI 対象可否の詳細設定

これらは、
付録Bおよび第7章（pytest 運用ポリシー）に従って実施される。

---

### 付録C：既存テスト棚卸し・再配置対応表（改定版）

| No. | テストファイルパス | 対応する付録Bの分類 | 想定レイヤー | 扱い（✔ / ✖ / →） | 再配置先の意味 | 備考 |
| --: | --------- | -------- | --------- | ------------- | --------- | ------- |
| 1 | tests/test_smoke_llm.py | Smoke Test | Layer 1（Contract） | ✔ | 付録B: Smoke Test | CI 必須 |
| 2 | tests/rag_entry/test_gate1_entry_minimal.py | Gate1 Entry Minimal | Layer 1（Contract） | ✔ | 付録B: Gate1 Entry Minimal | submit 完了セマンティクス |
| 3 | tests/rag_entry/test_gate1_schema_entry.py | F4 trial dataset schema tests | Layer 3（Evaluation） | ✖ | pytest 対象外 | Layer 3 引退方針 |
| 4 | tests/f4/test_f4_case1_writer.py | F4 trial dataset | Layer 3（Evaluation） | ✖ | pytest 対象外 | 成果物生成のみ |
| 5 | tests/f4/test_f4_case2_writer.py | F4 trial dataset | Layer 3（Evaluation） | ✖ | pytest 対象外 | 同上 |
| 6 | tests/f4/test_f4_case3_writer.py | F4 trial dataset | Layer 3（Evaluation） | ✖ | pytest 対象外 | 同上 |
| 7 | tests/_legacy/rag/test_rag_basic_ask_v0_2.py | 旧 RAG Tests | Legacy | ✖ | 廃止 | 後方互換不要 |
| 8 | tests/diagnostic/test_profile_resolution.py | 実行プロファイル解決 | Layer 1（Contract） | ✔ | 付録B: Contract Tests | 実行前提保証 |
| 9 | tests/rag/test_rag_basic_v0_1.py | Basic RAG Tests | Layer 2（Behavior） | → | 付録B: Basic RAG Tests | CI 非対象へ |
| 10 | tests/rag/test_rag_advanced_v0_1.py | Advanced RAG Tests | Layer 2（Behavior） | → | 付録B: Advanced RAG Tests | 観測専用 |
| 11 | tests/f9/a/binding/test_ordinance_binder.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 条例処理前提 |
| 12 | tests/f9/a/question/test_template_validator.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 質問生成前提 |
| 13 | tests/f9/a/question_set/test_csv_loader.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 質問供給前提 |
| 14 | tests/f9/a/resolution/test_auto_resolver.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 解決工程前提 |
| 15 | tests/f9/a/resolution/test_user_input_resolver.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 同上 |
| 16 | tests/f9/a/test_a1_a2_integration.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 工程接続保証 |
| 17 | tests/f9/a/test_a2_a3_integration.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 同上 |
| 18 | tests/f9/a/test_a3_a4_integration.py | Contract Tests | Layer 1（Contract） | ✔ | 付録B: Contract | 同上 |

---

本付録は、  
「なぜこのテストは pass / fail を持たないのか」  
「なぜ CI で実行されないのか」  
といった疑問に対する**最終的な回答**として機能する。
